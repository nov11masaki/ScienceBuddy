# クラス別チャットボット制御機能

## 概要

教員が各クラス（1組〜4組）のチャットボット利用を個別に制御できる機能です。

## アカウント構成

### 教員アカウント

| アカウントID | パスワード | 制御可能なクラス | 説明 |
|------------|----------|----------------|------|
| `teacher` | `science2025` | 全クラス (1〜4組) | 全体管理者（あなた） |
| `teacher_class1` | `class1_2025` | 1組のみ | 1組担任 |
| `teacher_class2` | `class2_2025` | 2組のみ | 2組担任 |
| `teacher_class3` | `class3_2025` | 3組のみ | 3組担任 |
| `teacher_class4` | `class4_2025` | 4組のみ | 4組担任 |

### 生徒番号とクラスの対応

| クラス | 生徒番号範囲 | 人数 |
|-------|------------|------|
| 1組 | 4101〜4130 | 30名 |
| 2組 | 4201〜4230 | 30名 |
| 3組 | 4301〜4330 | 30名 |
| 4組 | 4401〜4430 | 30名 |

**特別ID**: `1111` - テスト用ID（全クラスで常に利用可能）

## 機能の使い方

### 1. 教員ログイン

1. トップページから「教員用ページ」をクリック
2. 教員ID・パスワードを入力してログイン
   - 例: `teacher_class1` / `class1_2025` (1組担任)
   - 例: `teacher` / `science2025` (全体管理者)

### 2. クラス別制御

教員ダッシュボードの「学習サポートチャットボット - クラス別制御」セクションで:

#### 担任アカウントの場合
- **表示**: 自分の担当クラスのみ制御可能
- **他クラス**: 「編集権限がありません」と表示
- **操作**: 
  - 「有効」ボタン → チャットボット利用可能
  - 「無効」ボタン → チャットボット利用不可

#### 全体管理者 (teacher) の場合
- **表示**: 全クラス (1〜4組) の制御が可能
- **操作**: 各クラスを個別に制御可能

### 3. 生徒側の動作

#### チャットボットが有効な場合
1. 生徒がホーム画面にログイン
2. 「学習サポートチャットボット」ボタンが表示される
3. クリックするとチャットボットにアクセス可能

#### チャットボットが無効な場合
1. 生徒がホーム画面にログイン
2. 「学習サポートチャットボット」ボタンが表示される
3. クリックすると「現在、チャットボットは利用できません」と表示
4. 自動的に生徒番号選択画面にリダイレクト

## 技術仕様

### 設定ファイル: `chatbot_config.json`

```json
{
  "enabled": true,
  "classes": {
    "class1": {
      "enabled": true,
      "updated_at": "2025-10-17T15:30:00.000000"
    },
    "class2": {
      "enabled": false,
      "updated_at": "2025-10-17T14:20:00.000000"
    },
    "class3": {
      "enabled": true,
      "updated_at": "2025-10-17T13:10:00.000000"
    },
    "class4": {
      "enabled": true,
      "updated_at": "2025-10-17T12:00:00.000000"
    }
  },
  "updated_at": "2025-10-17T15:30:00.000000"
}
```

### 主要な関数

#### `get_student_class(student_number)`
生徒番号からクラスを特定
- 入力: 生徒番号 (int or str)
- 出力: クラス名 ("class1", "class2", "class3", "class4") または "all" (1111の場合)

#### `get_teacher_classes(teacher_id)`
教員IDから管理可能なクラス一覧を取得
- 入力: 教員ID
- 出力: クラス名のリスト ["class1", "class2", ...]

#### `get_chatbot_status(class_name=None)`
チャットボットの有効/無効状態を取得
- 入力: クラス名 (オプション)
- 出力: True (有効) / False (無効)

#### `set_chatbot_status(enabled, class_name=None)`
チャットボットの有効/無効状態を設定
- 入力: enabled (bool), class_name (オプション)
- 出力: True (成功) / False (失敗)

### API エンドポイント

#### `POST /teacher/chatbot/toggle`
チャットボットの表示状態を切り替え

**リクエスト**:
```json
{
  "enabled": true,
  "class_name": "class1"
}
```

**レスポンス**:
```json
{
  "success": true,
  "enabled": true,
  "class_name": "class1"
}
```

**エラー**:
```json
{
  "success": false,
  "error": "権限がありません"
}
```

## セキュリティ

### 権限チェック

1. **ログイン必須**: `@require_teacher_auth` デコレータ
2. **クラス権限**: 教員が担当クラス以外を制御しようとすると 403 エラー
3. **セッション管理**: Flask セッションで認証状態を管理

### 生徒側の制限

1. **クラス特定**: 生徒番号から自動的にクラスを判定
2. **状態確認**: チャットボットアクセス時に該当クラスの設定を確認
3. **リダイレクト**: 無効な場合は自動的に番号選択画面に戻す

## 使用例

### 例1: 1組担任が1組のチャットボットを無効化

1. `teacher_class1` でログイン
2. ダッシュボードで「1組」の「無効」ボタンをクリック
3. 1組の生徒 (4101〜4130) はチャットボットにアクセス不可
4. 2〜4組は影響なし

### 例2: 全体管理者が全クラスを一括制御

1. `teacher` でログイン
2. ダッシュボードで各クラスを個別に制御
3. 必要に応じて一部クラスのみ有効化

### 例3: テストID (1111) の動作

1. 生徒が `1111` でログイン
2. 全クラスの設定に関わらず常に利用可能
3. テスト・デモ用途に使用

## トラブルシューティング

### Q: 担任が他クラスを制御できない

**A**: 仕様通りの動作です。担任は自分の担当クラスのみ制御可能です。

### Q: 設定が保存されない

**A**: 
1. `chatbot_config.json` の書き込み権限を確認
2. ブラウザのコンソールでエラーを確認
3. サーバーログを確認

### Q: 生徒がチャットボットにアクセスできない

**A**:
1. 該当クラスの設定が「有効」になっているか確認
2. 生徒番号が正しい範囲か確認 (4101〜4430, 1111)
3. ログアウト後、再ログインを試す

## 今後の拡張可能性

- [ ] クラス別の利用時間帯制限
- [ ] クラス別のチャット履歴表示
- [ ] 利用状況の統計・グラフ表示
- [ ] 一括制御機能（全クラス一括有効/無効）
- [ ] スケジュール設定（自動的に有効/無効を切り替え）

## 関連ファイル

- `app.py`: バックエンドロジック
- `templates/teacher/dashboard.html`: 教員ダッシュボードUI
- `templates/teacher/login.html`: 教員ログインページ
- `chatbot_config.json`: 設定ファイル
- `docs/クラス別チャットボット制御.md`: 本ドキュメント

---

**作成日**: 2025年10月17日  
**対象**: 教員・システム管理者  
**目的**: クラス別チャットボット制御機能の説明
