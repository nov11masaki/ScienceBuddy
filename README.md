# 🔬 ScienceBuddy（サイエンスバディ）

小学4年生の理科学習で「変化」に着目させるAI対話型Webアプリケーション。子どもと一緒に実験の結果を観察し、「何が変わった？」という問いから科学的思考を育みます。

---

## 📖 プロダクト概要

### 何ができるアプリか
ScienceBuddy は、小学校理科の学習過程において、子ども達が**「変化」に気づき、その理由を考え、日常と結びつける**のをAIが支援します。

- 📝 **予想段階（AI対話）**: 子どもの経験から「どう変わると思う？」という根拠を引き出す
- 🔍 **実験段階（教員主導）**: 児童が実際に実験を実施して「何が変わったか」を観察
- 💭 **考察段階（AI対話）**: 実際の変化と予想を比較しながら、新しい理解を形成
- 📋 **記録**: 全ての対話と学習過程をJSON形式でログに記録

### 教育的アプローチ
子どもの **「あ、変わった！」という気づき** を大切にしながら、自然な対話の中で科学的思考を育みます。

---

## 🎯 主な機能

### 👨‍🎓 学習者用機能
- **クラス選択** - 1組〜4組、研究室（研究室）からの選択
- **出席番号選択** - 各クラス1〜30番からの選択（カード形式UI）
- **学習単元選択** - 小学4年生理科の熱と温度関連単元から選択

#### 🔐 同時アクセス防止機能
- **デバイス指紋認証**: User-Agent とIPアドレスからデバイスIDを生成
- **セッション競合検出**: 同じ学生アカウントから異なるデバイスでのアクセスを検出
- **自動セッション切断**: 新しいデバイスからのアクセス時に、古いセッションを自動的にクリア
- **ユーザー通知**: 別デバイスでのアクセスが検出された場合、フラッシュメッセージで通知
- **目的**: 学習の中断や混乱を防ぐため、同じ学生が1台のデバイスのみで学習することを推奨

#### 📱 AI対話支援（チャット形式）
- **予想段階**: 
  - 子どもの予想を受け止める
  - 理由や経験を自然に引き出す
  - 1つ出た経験を深く掘り下げる
  
- **考察段階**:
  - 実験結果を受け止める
  - 予想と比べる（「当たった？」「どこが違う？」）
  - なぜそうなったか考える（ソクラテス問答）
  - 日常生活とつなげる（1つで十分）

#### 📝 対話結果の要約
- 対話内容から自動的に予想・考察文を提案
- テンプレート形式に固執しない **子ども本位の要約**
- 子どもの言葉や表現を活かす（「ボコボコ」「〜みたい」など）

### 多様な入力方法
- **キーボード入力**（標準）
- **50音キーボード**（ひらがな50音配列、トグル ON/OFF）
  - 濁点・半濁点ボタンによる循環入力（例: は → ば → ぱ → は）
  - あ〜わ行すべての文字に対応
  - スマートフォン・タブレット最適化
- **音声入力**（リアルタイム認識、トグル ON/OFF）
  - Web Speech API使用
  - 話しながら随時テキストに変換
  - 継続的な音声認識で自然な入力
  - Chrome、Edge、Safari対応

#### 🎨 使いやすいUI
- チャット形式の対話画面
- 50音表オン/オフ切り替えで画面最適化
- 入力エリアのアニメーション
- モバイルフレンドリーデザイン

#### 📸 ノート写真撮影機能
- 実験ノートをカメラで撮影
- 1回のセッションで複数枚撮影可能
- 写真は自動的にタイムスタンプ付きで保存
- 取り直し機能で不要な写真をクリア

### 👩‍🏫 教員用機能
- **認証システム** - 教員専用ログイン
- **学習ログ確認** - 学生の対話プロセス詳細表示
  - タイムライン形式での学習過程
  - 予想・考察の各段階での対話内容
  - クラス・出席番号・単元・日付でフィルタリング可能
- **学習進捗管理** - 学生ごとの学習状況把握
  - 各単元の完了状況
- **クラス別分析** - 各単元ごとの学習パターン分析
  - 全学生の対話をテキスト形式で分析
  - 思考傾向や着想の傾向を自動抽出
- **学習パターンのクラスタリング** - 学生グループ化機能
  - OpenAI Embedding による対話パターン分析
  - KMeans クラスタリングで学生を自動グループ化
  - 予想段階と考察段階を分離して分析
  - 同じような思考パターンを持つ学生をグループ化
  - 学生の詳細ログへのアクセス
- **ノート写真確認** - 生徒が撮影した実験ノート写真の管理
  - クラス・児童ごとのフィルタリング
  - 単元ごとの絞り込み
  - 写真の拡大表示
  - ZIP形式での一括ダウンロード
  - 写真の削除機能

---

## 📚 対応学習単元（小学4年生 熱と温度）

| 単元 | 主な学習内容 |
|------|-----------|
| 🔥 **金属のあたたまり方** | 金属の熱伝導と温まり方 |
| 💧 **水のあたたまり方** | 液体の対流と温まり方 |
| 💨 **空気の温度と体積** | 気体の性質と温度変化 |
| 🌡️ **水を冷やし続けた時の温度と様子** | 冷却と温度の関係 |

## 👥 クラス構成

| クラス | 説明 | 学生ID範囲 | 出席番号 |
|--------|------|----------|--------|
| **1組** | 4年1組 | 1001-1030 | 1-30 |
| **2組** | 4年2組 | 2001-2030 | 1-30 |
| **3組** | 4年3組 | 3001-3030 | 1-30 |
| **4組** | 4年4組 | 4001-4030 | 1-30 |
| **研究室** | 研究室・特別クラス | 5001-5030 | 1-30 |

---

## 🛠️ 技術仕様

| カテゴリ | 技術スタック |
|--------|-----------|
| **バックエンド** | Flask (Python 3.9+) |
| **AI** | OpenAI API (gpt-4o-mini) |
| **AI Embedding** | OpenAI API (text-embedding-3-small) |
| **機械学習** | scikit-learn (KMeans クラスタリング) |
| **数値計算** | NumPy |
| **AIコスト最適化** | OpenAI Prompt Caching (入力トークン90%削減) |
| **フロントエンド** | HTML5, CSS3, JavaScript, Bootstrap 5 |
| **クラウド環境** | Google Cloud Run, Cloud Storage, Cloud Build |
| **ホスト環境** | ステートレスコンテナ（Docker） |
| **データ保存** | Cloud Storage（本番）、JSON形式ログ（ローカル） |
| **セッション管理** | Flask Session |
| **プロンプト** | Markdown形式 (CIIO構造) |
| **デザイン** | レスポンシブ・モダンUI |

---

## 🚀 セットアップ・起動方法

### ローカル開発環境

#### 1. パッケージのインストール
```bash
pip install -r requirements.txt
```

#### 2. 環境変数の設定
`.env`ファイルを作成：
```env
OPENAI_API_KEY=your_actual_openai_api_key_here
FLASK_ENV=development
```

#### 3. アプリケーション起動
```bash
python app.py
```

#### 4. アクセス
- **学習者用**: http://localhost:5014
- **教員用**: http://localhost:5014/teacher

### 本番環境（Google Cloud Run デプロイ）

#### 前提条件
- Google Cloud Project
- Cloud Build有効化（GitHub連携）
- Cloud Storage バケット作成

#### デプロイ手順
```bash
# 1. Google Cloud CLIでプロジェクト認証
gcloud auth login
gcloud config set project PROJECT_ID

# 2. Cloud Storageバケット作成（ログ・進捗保存用）
gsutil mb gs://YOUR_BUCKET_NAME/

# 3. Cloud Runにデプロイ
gcloud run deploy science-buddy \
  --source . \
  --platform managed \
  --region asia-northeast1 \
  --allow-unauthenticated \
  --set-env-vars OPENAI_API_KEY=your_api_key,BUCKET_NAME=YOUR_BUCKET_NAME,FLASK_ENV=production
```

#### 環境変数（Cloud Run）
| 変数 | 説明 | 例 |
|------|------|-----|
| `OPENAI_API_KEY` | OpenAI API キー | `sk-proj-...` |
| `BUCKET_NAME` | Cloud Storage バケット名 | `science-buddy-logs` |
| `FLASK_ENV` | 環境タイプ | `production` |

#### デプロイ確認
```bash
# Cloud Runのログを確認
gcloud run logs read science-buddy --region asia-northeast1

# Cloud Storageのファイル確認
gsutil ls gs://YOUR_BUCKET_NAME/logs/
gsutil ls gs://YOUR_BUCKET_NAME/learning_progress.json
```

**本番環境へのアクセス**: `https://science-buddy-xxxxx.run.app`

---

## 💡 教育的配慮・設計哲学

### 「変化」に着目させる対話設計

#### 基本的な考え方
科学学習の第一歩は、**「何が変わったのか」に気づくこと**です。ScienceBuddy では、子どもが実験を通じて観察した「変化」を中心に対話を進めます。

#### 学習の流れ
1. **予想段階（AI対話）**: 
   - 「どう変わると思う？」と子どもの予想を引き出す
   - 過去の経験から根拠を探る
   - 対話終了後、AIが予想文を自動生成
   
2. **実験段階（教員主導・AI対話なし）**: 
   - 教室で実際に実験を実施
   - 子どもが「何が変わったか」を観察
   - 完了ボタンを押して次へ進む
   
3. **考察段階（AI対話）**: 
   - 実際の変化と予想を比較する
   - 「何が変わった？」「どこが違った？」という問いで理解を深める
   - 日常生活の中で似たような「変化」を見つけさせる
   - 対話終了後、AIが考察文を自動生成

#### AI対話の姿勢
- **子どもが言ったことを最優先** - テンプレートに固執しない
- **変化に焦点を当てる** - 「どう変わった？」という問いで思考を促す
- **自然な会話** - 短く、わかりやすい言葉で、子どもと一緒に観察する感覚で対話
- **経験を深く掘り下げる** - 1つの経験から、その背景にある「変化」の理由を考えさせる
- **子どもらしい表現を尊重** - 「ボコボコ」「パンパン」などの言葉もそのまま活かす

#### 考察段階での流れ例
```
AI: 「実験でどんな変化があった？」
子ども: 「タイヤがパンパンになった」
AI: 「なるほど、タイヤがパンパンになったんだね」
AI: 「最初の予想では、どう変わると思ってた？」
子ども: 「ちょっと大きくなると思ってた」
AI: 「へえ、ちょっと大きくなるって思ってたけど、実際は？」
子ども: 「ものすごく大きくなった」
AI: 「そっか、想像以上に大きくなったんだ。」
AI: 「そういう『すごく大きくなる』ことって、日常生活でも見たことある？」
子ども: 「夏、自転車のタイヤが硬くなる」
```

### 要約作成の特徴
- **子どもが話した内容と順序を最優先** - テンプレート形式に固執しない
- **「変化」を中心に** - 子どもが観察した変化を明確に記述
- **子どもらしい表現を残す**
  - 「気がする」「〜みたい」などの曖昧な表現もOK
  - 「ボコボコ」などの擬音語もそのまま活かす
  - 「パンパン」「ペコペコ」などのオノマトペも尊重
- **話した順序を尊重** - 子どもが自然に話した流れをそのまま活かす

**要約例（子どもの観察を中心に）**:
- 「夏の日にタイヤがパンパンになった。だから、あたためるとタイヤが大きくなると思った。」
- 「やかんでお湯をわかしたとき、ボコボコしてきて湯気が出た。温度が上がるとこんなに変わるんだ。」
- 「水をあたためると、上の方があたたかくなった。ずっと下はつめたかった。」

### AI対話の設計原則
1. **「変化」を中心に** - 子どもが見た・観察した「変化」を大切にする
2. **経験は1つで十分** - 無理に複数聞き出さない。1つの経験を深く掘り下げる
3. **子どもの考えを尊重** - 科学的に完璧でなくても、子どもなりの気づきを大切に
4. **予想と結果の比較を大切に** - 「当たった？」「どこが違う？」という問いで思考を促す
5. **柔軟に対応** - 指示は目安。子どもの反応に合わせて自然に会話する
6. **テンプレートに固執しない** - 子どもが話した順序と言葉を最優先する

## 🎨 UI/UX特徴

### デザイン
- **クリーンデザイン**: 白ベース・ライトブルーアクセントの小学生向けUI
- **直感的操作**: カード形式の選択とチャット形式の対話
- **レスポンシブデザイン**: スマートフォン・タブレット対応
- **アクセシビリティ**: 小学生にも使いやすいインターフェース
- **教員ダッシュボード**: モダンなグラデーション背景とGridレイアウト

### 入力エリアの最適化

#### デフォルト設定
- **50音表**: OFF（チャット画面を最大化）
- **音声入力**: OFF（キーボード操作を優先）
- **入力エリア**: コンパクト表示（アバター 32px、フォント 0.75rem）

#### 50音表 OFF 時
- **入力エリア高さ**: 12vh（コンパクト）
- **チャット領域**: 約88vh（最大化）
- **入力アバター**: 32px
- **入力フォント**: 0.75rem

#### 50音表 ON 時
- **入力エリア高さ**: 45vh（通常）
- **チャット領域**: 約55vh
- **入力アバター**: 42px
- **入力フォント**: 0.95rem

#### アニメーション
- **トグル時**: スムーズな transitionアニメーション（0.4s ease-out）
- **slideDown**: 50音表 OFF 時の縮小アニメーション
- **slideUp**: 50音表 ON 時の拡大アニメーション

### 多様な入力方法
- **キーボード入力**（標準）
- **タッチキーボード**（ひらがな50音配列、トグル ON/OFF）
  - 濁点・半濁点ボタンによる循環入力（例: は → ば → ぱ → は）
  - あ〜わ行すべての文字に対応
- **フリック入力**（スマホライク）
- **音声入力**（リアルタイム認識、トグル ON/OFF）
  - 話しながら随時テキストに変換
  - 継続的な音声認識で自然な入力
  - Chrome、Edge、Safari対応

## 📊 学習ログ管理機能

### 学習記録の閲覧
このシステムは学習者の対話プロセスを詳細に記録し、教員が確認できます。

- **日付別ログ管理**
  - 日付ごとに自動保存される学習ログ
  - 過去のログの閲覧・検索
  
- **フィルタリング機能**
  - 日付、単元、出席番号による絞り込み
  - 複数条件での柔軟な検索

- **詳細な学習過程の確認**
  - タイムライン形式での対話履歴表示
  - 予想・考察各段階での対話内容
  - 学習者の思考プロセスの可視化

### 学習ログの活用
- 個別指導への活用
- 学習者の理解度確認
- 指導改善のための分析データ

## 📁 ディレクトリ構造

```
ScienceBuddy/
├── app.py                      # Flaskアプリケーション本体
├── requirements.txt            # Python依存パッケージ
├── .env                       # 環境変数（OpenAI APIキー等）
├── learning_progress.json     # 学習進捗管理ファイル
├── logs/                      # 学習ログ（日付別自動生成）
│   └── learning_log_YYYYMMDD.json
├── prompts/                   # 単元別AIプロンプト（CIIO形式）
│   ├── 金属のあたたまり方.md
│   ├── 水のあたたまり方.md
│   ├── 空気の温度と体積.md
│   └── 水を熱し続けた時の温度と様子.md
├── tasks/                     # 単元別課題文（学習者に表示）
│   ├── 金属のあたたまり方.txt
│   ├── 水のあたたまり方.txt
│   ├── 空気の温度と体積.txt
│   └── 水を熱し続けた時の温度と様子.txt
├── templates/                 # HTMLテンプレート
│   ├── base.html             # 共通ベーステンプレート
│   ├── index.html            # トップページ
│   ├── select_class.html     # クラス選択
│   ├── select_number.html    # 出席番号選択
│   ├── select_unit.html      # 単元選択
│   ├── prediction.html       # 予想段階（AI対話）
│   ├── experiment.html       # 実験段階（待機画面）
│   ├── reflection.html       # 考察段階（AI対話）
│   └── teacher/              # 教員用ページ
│       ├── login.html        # ログイン
│       ├── dashboard.html    # ダッシュボード
│       ├── logs.html         # 学習ログ一覧
│       └── student_detail.html  # 生徒詳細
├── static/                    # 静的ファイル
│   └── css/
│       └── style.css         # スタイルシート
└── uploads/                   # 一時ファイル保存（未使用）
```

## 📊 データ形式

### 学習ログ構造
```json
{
  "timestamp": "2025-10-21T10:30:00.000000",
  "student_number": "1",
  "class_number": "class1",
  "unit": "空気の温度と体積",
  "log_type": "prediction_chat",
  "data": {
    "user_message": "学習者の入力",
    "ai_response": "AIの応答",
    "conversation_count": 1
  }
}
```

### ログタイプ
- `prediction_chat`: 予想段階の対話
- `prediction_summary`: 予想のまとめ
- `reflection_chat`: 考察段階の対話
- `final_summary`: 最終考察

### プロンプト設計（CIIO形式）
各単元のプロンプトファイルは**CIIO形式**で統一されています：

```markdown
## 📚 Context（背景・前提）
- 学習内容（単元、学年、学習段階）
- 教育方針（ソクラテス問答法、子ども中心、自然な対話）
- 前提知識（語彙力、漢字制限、専門用語の扱い）

## 🎯 Instruction（指示・命令）
- 絶対に守るべき原則
- 対話の進め方（予想段階・考察段階）
- 禁止事項

## 📥 Input Data（入力データ・参考データ）
- 児童からの入力例
- 児童の経験例
- 要約作成時の参考データ

## 📤 Output Indicator（出力条件・出力基準）
- 出力形式（1往復ごと、自然な対話文）
- 出力のタイミング（通常の応答、要約）
- 出力品質基準（小学3年生までの漢字のみ使用）
```

**プロンプト設計の特徴**:
- すべてのAI動作指示がプロンプトファイルに集約
- app.pyでは余計な指示を追加しない（プロンプトをそのまま渡す）
- プロンプトファイルの編集だけで対話方針を変更可能

## 🔬 対話の特徴

### 自然な質問の工夫
AIは形式的な質問ではなく、自然な会話を心がけます：

| ❌ 避けたい聞き方 | ✅ 自然な聞き方 |
|-----------------|---------------|
| 「関係があるのかな？」 | 「それって、〇〇と似てる？」 |
| 「どんなふうに関係していると思う？」 | 「どんなふうに変わったと思う？」 |
| 「どうしてそう思うの？」 | 「そう思ったのは、前に見たことがあるから？」 |
| 「なぜそうなると思う？」 | 具体的な事象を問う質問 |
| 「それは関係ある？」 | 「それと同じようなこと、ほかにもある？」 |

### 対話例：予想段階
```
AI: 「金属はどんな風にあたたまっていくかな？」
子ども: 「火の近くから」
AI: 「なるほど、火の近くからだと思うんだね」
AI: 「それはどうしてそう思ったの？」
子ども: 「スプーンを熱いコーヒーに入れたとき、持ち手まで温まったから」
AI: 「そのとき、どうなってたの？」
子ども: 「最初は先だけ熱くて、だんだん持ち手も熱くなった」
```

### 対話例：考察段階
```
AI: 「実験でどんな結果になった？」
子ども: 「火の近くから順番に温まった」
AI: 「へえ、火の近くから順番に温まったんだね」
AI: 「最初に思ってたのと同じだった？」
子ども: 「同じだった」
AI: 「普段の生活でも同じようなことってある？」
子ども: 「フライパンの取っ手が熱くなる」
```

## 🚨 運用上の注意事項

### セキュリティ
- **APIキー管理**: `.env`ファイルにOpenAI APIキーを保存（Gitにコミットしない）
- **Secret Key**: 本番環境では`app.py`内のFlask secret_keyを安全なランダム値に変更
- **教員認証**: 現在は簡易的な認証（本番運用時は強化推奨）

### システム設定
- **ポート番号**: デフォルトは5014（`app.py`最下部で変更可能）
- **ログ保存**: `logs/`ディレクトリに日付別JSON形式で自動保存
- **進捗管理**: `learning_progress.json`に各生徒の学習段階を記録

### カスタマイズ方法
- **新しい単元の追加**: 
  1. `tasks/`に課題文ファイル追加
  2. `prompts/`に対応するCIIO形式プロンプト追加
  3. `app.py`の`available_units`リストに追加
- **UI変更**: `static/css/style.css`を編集
- **AI対話調整**: `prompts/`内の各プロンプトファイルを編集（app.pyの変更不要）

## 🆕 最新アップデート（2025年11月）

### v1.3 - コスト最適化 & プロンプトキャッシング
- **OpenAI Prompt Caching** - システムプロンプトをキャッシュして入力トークンコスト90%削減
  - 予想段階（`/chat`）：単元別プロンプトをキャッシュ
  - 考察段階（`/reflect_chat`）：考察プロンプトをキャッシュ  
  - 予想要約（`/summary`）：要約プロンプトをキャッシュ
  - 考察要約（`/final_summary`）：考察要約プロンプトをキャッシュ
- **本番環境の完全統合**：Cloud RunとCloud Storageを使用した完全ホスト
  - GitHub自動デプロイ（Cloud Build トリガー）
  - Cloud Storageへの学習ログ・進捗データ保存
  - ステートレスコンテナ実行
- **モデル統一** - すべてのエンドポイント（対話・要約）で gpt-4o-mini を使用（コスト効率・十分な品質）
- **埋め込み + クラスタリング分析** - 学生の対話パターンを自動分析してグループ化

### v1.2 - 入力機能強化
- **濁点・半濁点循環ロジック** - 50音キーボードで濁点ボタンを押すと循環変換（は → ば → ぱ → は）

### v1.1 - UI/UX改善
- **リアルタイム音声入力** - Web Speech APIで話しながらテキスト変換（Chrome、Safari対応）
- **50音キーボードの最適化** - トグルによる表示/非表示、入力エリアの動的サイズ調整

### v1.0 - プロンプト設計刷新
- **CIIO形式プロンプト** - 全単元のプロンプトを構造化（Context/Instruction/Input/Output）
- **柔軟な要約生成** - 子どもの自然な話し言葉を尊重（テンプレート非依存）
- **コード簡素化** - app.pyから冗長な指示を削除、プロンプトファイルに一元化
- **漢字制限の明確化** - AIは小学3年生までの漢字のみ使用
- **対話方針の強化**
  - 1つの経験を深く掘り下げる
  - 子どもの言葉を最優先
  - 要約で子どもらしい表現（「気がする」「ボコボコ」など）を尊重

## 🚀 クイックスタート

```bash
# リポジトリのクローン
git clone https://github.com/nov11masaki/ScienceBuddy.git
cd ScienceBuddy

# 依存関係のインストール
pip install -r requirements.txt

# 環境変数の設定（.envファイルを作成）
echo "OPENAI_API_KEY=your_openai_api_key_here" > .env

# アプリケーションの起動
python app.py
```

その後、ブラウザで http://localhost:5014 にアクセスしてください。

## 🔗 関連技術

- **Flask**: Pythonウェブフレームワーク
- **OpenAI API**: gpt-4o-mini による自然言語処理・text-embedding-3-small による埋め込み
- **scikit-learn**: KMeans クラスタリングで学生の思考パターン分析
- **Bootstrap 5**: レスポンシブWebデザイン
- **Markdown形式プロンプト**: CIIO構造による単元別教育設計
- **対話型学習**: 子どもの「気づき」を大切にする教育設計