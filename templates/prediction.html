{% extends "base.html" %}

{% block title %}予想を立てよう{% endblock %}

{% block content %}
<div class="chat-page-vertical">
    <div class="container-fluid h-100">
        <!-- 上半分: 対話画面 -->
        <div class="chat-section">
            <div class="chat-header text-center mb-2">
                <h2 class="mb-2">
                    <i class="fas fa-brain text-primary"></i>
                    予想を立てよう
                </h2>
                <div class="unit-display">
                    <span class="badge bg-primary fs-6">{{ unit }}</span>
                </div>
            </div>
            
            <div class="task-section mb-2">
                <div class="task-card">
                    <h5 class="task-title">
                        <i class="fas fa-clipboard-list"></i>
                        課題
                    </h5>
                    <p class="task-content">{{ task_content }}</p>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="api-status" id="apiStatus" style="display: none;">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="apiStatusMessage">AI接続を確認中...</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="testApiConnection()">
                            <i class="fas fa-sync"></i> 再テスト
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        <div class="message-avatar"></div>
                        <div class="message-content">
                            {{ initial_ai_message }}
                        </div>
                    </div>
                    
                    <!-- 入力エリア（直接入力可能） -->
                    <div class="message user-message user-input-area input-compact" style="margin-top: 12px;">
                        <div class="input-with-send">
                            <textarea class="user-input-bubble placeholder-input" id="messageInput" placeholder="ここに入力してください"></textarea>
                            <button class="send-button" id="sendButton" title="送信">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons text-center mt-2">
                <button class="btn btn-success" id="summaryButton" style="display: none;">
                    <i class="fas fa-check me-2"></i>
                    予想をまとめる
                </button>
            </div>
            
            <!-- チャット内で表示される実験開始ボタン -->
            <div class="text-center mt-3" id="experimentButtonSection" style="display: none;">
                <a href="/experiment" class="btn btn-primary btn-lg">
                    <i class="fas fa-flask me-2"></i>
                    では、実験を始めましょう！
                </a>
            </div>
            
            <div class="summary-section" id="summarySection" style="display: none;">
                <div class="summary-card">
                    <h5 class="summary-title">
                        <i class="fas fa-lightbulb"></i>
                        あなたの予想
                    </h5>
                    <div class="summary-content" id="summaryContent"></div>
                    <div class="text-center mt-3">
                        <a href="/experiment" class="btn btn-primary">
                            <i class="fas fa-flask me-2"></i>
                            実験を始める
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 下半分: 入力補助エリア -->
        <div class="input-assist-section" id="inputAssistSection">
            <div class="input-assist-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> 入力エリア
                    </h5>
                    <div class="input-mode-switches">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="toggle50on">
                            <label class="form-check-label" for="toggle50on">
                                50音表
                            </label>
                        </div>
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" id="toggleVoice">
                            <label class="form-check-label" for="toggleVoice">
                                音声入力
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 50音表キーボード -->
            <div class="keyboard-area-fullscreen" id="keyboardArea">
                <div class="touch-keyboard-panel" id="touchKeyboard">
                    <div class="keyboard-grid-vertical" id="hiraganaKeys">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 入力コントロールエリア -->
            <div class="input-controls-area">
                <!-- 音声入力ボタン -->
                <div class="voice-input-section mb-2" id="voiceInputSection" style="display: none;">
                    <button class="btn btn-outline-primary w-100" id="voiceInputBtn">
                        <i class="fas fa-microphone"></i> 音声で入力
                    </button>
                    <div class="voice-input-status mt-2" id="voiceInputStatus" style="display: none;">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-microphone"></i>
                            <span id="voiceStatusText">音声を認識中...</span>
                        </div>
                    </div>
                </div>
                
                <!-- キーボードコントロールボタン -->
                <div class="d-flex gap-2">
                    <button class="btn btn-warning flex-fill" id="backspaceBtn">
                        <i class="fas fa-backspace"></i> 消す
                    </button>
                    <button class="btn btn-danger flex-fill" id="clearBtn">
                        <i class="fas fa-times"></i> 全消去
                    </button>
                    <button class="btn btn-success" id="inputAssistSendBtn" title="送信">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conversationCount = 0;
let lastMessage = '';

// デジタル学習ツイン用の入力行動追跡
// 入力補助用の設定（シンプルなひらがなのみ）
const inputAssistConfig = {
    hiragana: [
        // 右から左への伝統的な50音表配置（縦書き）
        ['わ', 'ら', 'や', 'ま', 'は', 'な', 'た', 'さ', 'か', 'あ'],
        ['', 'り', '', 'み', 'ひ', 'に', 'ち', 'し', 'き', 'い'],
        ['を', 'る', 'ゆ', 'む', 'ふ', 'ぬ', 'つ', 'す', 'く', 'う'],
        ['', 'れ', '', 'め', 'へ', 'ね', 'て', 'せ', 'け', 'え'],
        ['ん', 'ろ', 'よ', 'も', 'ほ', 'の', 'と', 'そ', 'こ', 'お'],
        // 小さい文字と記号（左から右へ）
        ['゛゜', 'っ', 'ゃ', 'ゅ', 'ょ', '、', '。', '！', '？', 'スペース']
    ]
};

const currentUnit = "{{ unit }}";
let recognition = null;

// ページ読み込み時にAPI接続をテスト
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded イベント発火');
    
    testApiConnection();
    
    // デフォルトで50音表がOFFなので、入力補助エリアを縮小
    const inputAssistSection = document.getElementById('inputAssistSection');
    if (inputAssistSection) {
        inputAssistSection.classList.add('keyboard-off');
    }
    
    // 入力補助の初期化
    initializeInputAssist();
    
    // 入力モード切り替え
    document.querySelectorAll('input[name="inputMode"]').forEach(radio => {
        radio.addEventListener('change', switchInputMode);
    });
    
    // 50音表表示切り替えスイッチ
    const toggle50onSwitch = document.getElementById('toggle50on');
    if (toggle50onSwitch) {
        toggle50onSwitch.addEventListener('change', function() {
            const keyboardArea = document.getElementById('keyboardArea');
            const userInputArea = document.querySelector('.user-input-area');
            const inputAssistSection = document.getElementById('inputAssistSection');
            
            if (this.checked) {
                // 50音表を表示
                keyboardArea.style.display = 'flex';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-hidden', 'input-compact');
                    userInputArea.classList.add('keyboard-shown', 'input-normal');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-off');
                    inputAssistSection.classList.add('keyboard-on');
                }
            } else {
                // 50音表を非表示（入力エリア下降アニメーション + 縮小）
                keyboardArea.style.display = 'none';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-shown', 'input-normal');
                    userInputArea.classList.add('keyboard-hidden', 'input-compact');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-on');
                    inputAssistSection.classList.add('keyboard-off');
                }
            }
        });
    }
    
    // 音声入力切り替えスイッチ
    const toggleVoiceSwitch = document.getElementById('toggleVoice');
    if (toggleVoiceSwitch) {
        toggleVoiceSwitch.addEventListener('change', function() {
            const voiceSection = document.getElementById('voiceInputSection');
            if (this.checked) {
                voiceSection.style.display = 'block';
            } else {
                voiceSection.style.display = 'none';
                stopVoiceInput(); // 音声入力が有効な場合は停止
            }
        });
    }
    
    // 音声入力ボタン
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    console.log('voiceInputBtn要素:', voiceInputBtn);
    if (voiceInputBtn) {
        voiceInputBtn.addEventListener('click', function() {
            console.log('voiceInputBtnがクリックされました');
            startVoiceInput();
        });
        console.log('voiceInputBtnにイベントリスナーを設定しました');
    } else {
        console.error('voiceInputBtn要素が見つかりません');
    }
    
    // キーボードコントロールボタン（タッチキーボード用）
    const backspaceBtn = document.getElementById('backspaceBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    if (backspaceBtn) {
        backspaceBtn.addEventListener('click', function() {
            const input = document.getElementById('messageInput');
            if (input.value.length > 0) {
                input.value = input.value.slice(0, -1);
            }
            input.focus();
        });
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const input = document.getElementById('messageInput');
            input.value = '';
            input.focus();
        });
    }
    
    // Enterキーで送信
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // 送信ボタン（チャット入力エリア）
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessage);
    }
    
    // 送信ボタン（50音表エリア）
    const inputAssistSendBtn = document.getElementById('inputAssistSendBtn');
    if (inputAssistSendBtn) {
        inputAssistSendBtn.addEventListener('click', sendMessage);
    }
    
    // まとめボタン
    document.getElementById('summaryButton').addEventListener('click', getSummary);
});

// 入力補助の初期化
function initializeInputAssist() {
    // ひらがなキーボードを設定（10列グリッドレイアウト、右から左）
    const hiraganaContainer = document.getElementById('hiraganaKeys');
    hiraganaContainer.innerHTML = '';
    
    inputAssistConfig.hiragana.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary touch-key';
            if (char === '') {
                // 空白セル
                btn.style.visibility = 'hidden';
                btn.textContent = ' ';
            } else if (char === '゛゜') {
                // 濁点・半濁点ボタン
                btn.textContent = '゛゜';
                btn.className = 'btn btn-outline-secondary touch-key special-key';
                btn.onclick = () => addDakuten();
            } else if (char === 'スペース') {
                // スペースボタン
                btn.textContent = 'スペース';
                btn.className = 'btn btn-outline-info touch-key space-key';
                btn.onclick = () => insertText(' ');
            } else if (char === '、' || char === '。' || char === '！' || char === '？') {
                // 記号ボタン
                btn.textContent = char;
                btn.className = 'btn btn-outline-secondary touch-key';
                btn.onclick = () => insertText(char);
            } else {
                // 通常のひらがなボタン
                btn.textContent = char;
                btn.onclick = () => insertText(char);
            }
            hiraganaContainer.appendChild(btn);
        });
    });
}

// 濁点・半濁音を追加
function addDakuten() {
    const input = document.getElementById('messageInput');
    const text = input.value;
    if (text.length === 0) return;
    
    const lastChar = text[text.length - 1];
    
    // 濁点マップ
    const dakutenMap = {
        'か': 'が', 'き': 'ぎ', 'く': 'ぐ', 'け': 'げ', 'こ': 'ご',
        'さ': 'ざ', 'し': 'じ', 'す': 'ず', 'せ': 'ぜ', 'そ': 'ぞ',
        'た': 'だ', 'ち': 'ぢ', 'つ': 'づ', 'て': 'で', 'と': 'ど',
        'は': 'ば', 'ひ': 'び', 'ふ': 'ぶ', 'へ': 'べ', 'ほ': 'ぼ'
    };
    
    // 半濁点マップ
    const handakutenMap = {
        'は': 'ぱ', 'ひ': 'ぴ', 'ふ': 'ぷ', 'へ': 'ぺ', 'ほ': 'ぽ',
        'ば': 'ぱ', 'び': 'ぴ', 'ぶ': 'ぷ', 'べ': 'ぺ', 'ぼ': 'ぽ'
    };
    
    // は行なら濁点、濁音なら半濁点に変換
    if (dakutenMap[lastChar]) {
        input.value = text.slice(0, -1) + dakutenMap[lastChar];
    } else if (handakutenMap[lastChar]) {
        input.value = text.slice(0, -1) + handakutenMap[lastChar];
    }
    
    updateInputPreview();  // プレビュー更新
    input.focus();
}

// テキストを挿入（50音表から）
function insertText(text) {
    const input = document.getElementById('messageInput');
    input.value += text;
    input.focus();
}

// 入力補助の表示切り替え
function toggleInputAssist(enabled) {
    const keyboardDiv = document.getElementById('touchKeyboard');
    const voiceDiv = document.getElementById('voiceInputSection');
    
    if (enabled) {
        keyboardDiv.style.display = 'block';
        voiceDiv.style.display = 'block';
    } else {
        keyboardDiv.style.display = 'none';
        voiceDiv.style.display = 'none';
        stopVoiceInput();
    }
}

// 音声入力開始/停止
function startVoiceInput() {
    console.log('音声入力ボタンがクリックされました');
    
    // 既に認識中なら停止
    if (recognition && recognition.isListening) {
        console.log('音声認識を停止します');
        stopVoiceInput();
        return;
    }
    
    // Web Speech API のサポート確認
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('お使いのブラウザは音声入力に対応していません。Chrome、Edge、Safariをお使いください。');
        console.error('Web Speech API not supported');
        return;
    }
    
    console.log('Web Speech API サポート確認OK');
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    try {
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;  // 継続的に認識
        recognition.interimResults = true;  // 途中結果も取得
        
        console.log('SpeechRecognition オブジェクト作成完了');
        
        const statusDiv = document.getElementById('voiceInputStatus');
        const statusText = document.getElementById('voiceStatusText');
        const voiceBtn = document.getElementById('voiceInputBtn');
        const input = document.getElementById('messageInput');
        
        // 認識開始時の入力欄の位置を記憶
        let startPosition = 0;
        
        console.log('DOM要素取得:', {statusDiv, statusText, voiceBtn});
        
        recognition.onstart = function() {
            console.log('音声認識開始');
            recognition.isListening = true;
            startPosition = input.value.length;  // 現在の入力位置を記憶
            statusDiv.style.display = 'block';
            statusText.textContent = '音声を認識中...';
            voiceBtn.innerHTML = '<i class="fas fa-stop"></i> 停止';
            voiceBtn.classList.add('btn-danger');
            voiceBtn.classList.remove('btn-outline-primary');
        };
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        // 全ての結果を処理
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        // リアルタイムで入力欄に反映
        if (interimTranscript) {
            // 途中結果を表示（確定していない部分）
            input.value = input.value.substring(0, startPosition) + finalTranscript + interimTranscript;
            statusText.textContent = '認識中: ' + interimTranscript;
            console.log('途中結果:', interimTranscript);
        }
        
        if (finalTranscript) {
            // 確定した結果を入力欄に追加
            input.value = input.value.substring(0, startPosition) + finalTranscript;
            startPosition = input.value.length;  // 新しい開始位置を更新
            statusText.textContent = '認識完了: ' + finalTranscript;
            console.log('確定結果:', finalTranscript);
        }
        
        // 入力欄を最後までスクロール
        input.scrollTop = input.scrollHeight;
    };
    
    recognition.onerror = function(event) {
        console.error('音声認識エラー:', event.error);
        statusDiv.style.display = 'none';
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> 音声で入力';
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-primary');
        recognition.isListening = false;
        
        if (event.error === 'no-speech') {
            alert('音声が検出されませんでした。もう一度お試しください。');
        } else if (event.error === 'not-allowed') {
            alert('マイクの使用が許可されていません。ブラウザの設定を確認してください。');
        } else if (event.error !== 'aborted') {
            // aborted エラー（手動停止）以外はアラート表示
            alert('音声認識エラー: ' + event.error);
        }
    };
    
    recognition.onend = function() {
        console.log('音声認識終了');
        statusDiv.style.display = 'none';
        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i> 音声で入力';
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-primary');
        recognition.isListening = false;
    };
    
        console.log('音声認識を開始します');
        recognition.start();
    } catch (error) {
        console.error('音声認識エラー:', error);
        alert('音声認識の初期化に失敗しました: ' + error.message);
    }
}

// 音声入力停止
function stopVoiceInput() {
    console.log('音声入力停止');
    if (recognition && recognition.isListening) {
        recognition.stop();
        recognition.isListening = false;
    }
}

function testApiConnection() {
    fetch('/api/test')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('apiStatus');
        const messageSpan = document.getElementById('apiStatusMessage');
        
        if (data.status === 'success') {
            statusDiv.style.display = 'none';
            console.log('API接続テスト成功:', data.response);
        } else {
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-danger';
            messageSpan.textContent = data.message || 'AI接続に問題があります';
        }
    })
    .catch(error => {
        console.error('API接続テストエラー:', error);
        const statusDiv = document.getElementById('apiStatus');
        const messageSpan = document.getElementById('apiStatusMessage');
        statusDiv.style.display = 'block';
        statusDiv.className = 'alert alert-danger';
        messageSpan.textContent = 'ネットワーク接続に問題があります';
    });
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ユーザーメッセージを表示
    addMessage(message, 'user');
    input.value = '';
    
    // APIに送信
    sendMessageToAPI(message);
}

function addMessage(content, type) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    messageDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
            ${content}
        </div>
    `;
    
    // 入力エリアを取得
    const inputArea = document.querySelector('.user-input-area');
    
    // メッセージを追加
    if (inputArea) {
        // 入力エリアの前に追加（入力エリアが最後に来るように）
        messagesContainer.insertBefore(messageDiv, inputArea);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageDiv; // 作成されたメッセージ要素を返す
}

function addRetryButton() {
    const messagesContainer = document.getElementById('chatMessages');
    const retryDiv = document.createElement('div');
    retryDiv.className = 'message ai-message retry-message';
    retryDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
            <button class="btn btn-outline-primary btn-sm" onclick="retryLastMessage()">
                <i class="fas fa-redo me-2"></i>再試行
            </button>
        </div>
    `;
    
    // 入力エリアを取得
    const inputArea = document.querySelector('.user-input-area');
    
    if (inputArea) {
        // 入力エリアの前に追加
        messagesContainer.insertBefore(retryDiv, inputArea);
    } else {
        messagesContainer.appendChild(retryDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function retryLastMessage() {
    // 再試行ボタンを削除
    const retryMessages = document.querySelectorAll('.retry-message');
    retryMessages.forEach(msg => msg.remove());
    
    // 最後のユーザーメッセージを再送信
    const userMessages = document.querySelectorAll('.user-message .message-content');
    if (userMessages.length > 0) {
        const lastMessage = userMessages[userMessages.length - 1].textContent;
        // 直接APIを呼び出す
        sendMessageToAPI(lastMessage);
    }
}

function sendMessageToAPI(message) {
    console.log('【DEBUG】sendMessageToAPI 呼び出し, メッセージ:', message);
    
    // 読み込み中のメッセージを表示
    const loadingMessage = addMessage('考え中...', 'ai');
    loadingMessage.classList.add('loading-message');
    
    // APIリクエストデータ
    const requestData = { 
        message: message
    };
    
    console.log('【DEBUG】リクエストデータ:', requestData);
    
    // AIの応答を取得
    fetch('/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('【DEBUG】レスポンス受信:', response.status, response.statusText);
        
        // 読み込み中メッセージを削除
        const loadingMessages = document.querySelectorAll('.loading-message');
        loadingMessages.forEach(msg => msg.remove());
        
        if (!response.ok) {
            throw new Error(`HTTPエラー: ${response.status} ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('【DEBUG】JSONレスポンス:', data);
        
        if (data.error) {
            console.error('【DEBUG】エラーレスポンス:', data.error);
            addMessage('⚠️ ' + data.error, 'ai');
            addRetryButton();
        } else {
            console.log('【DEBUG】AI返答を表示:', data.response);
            addMessage(data.response, 'ai');
            conversationCount++;
            
            // AIのメッセージが「まとめ」に関する内容だったら、要約ボタンを表示
            if (data.response.includes('まとめ')) {
                console.log('【DEBUG】要約ボタンを表示します');
                document.getElementById('summaryButton').style.display = 'block';
            }
            
            // デジタル学習ツインのインサイトを表示（開発時のみ）
            if (data.twin_insights && window.location.hostname === 'localhost') {
                console.log('学習ツイン分析:', data.twin_insights);
                displayTwinInsights(data.twin_insights);
            }
        }
    })
    .catch(error => {
        // 読み込み中メッセージを削除
        const loadingMessages = document.querySelectorAll('.loading-message');
        loadingMessages.forEach(msg => msg.remove());
        
        console.error('【DEBUG】エラーキャッチ:', error);
        console.error('通信エラー詳細:', error);
        addMessage('⚠️ 通信エラーが発生しました: ' + error.message, 'ai');
        addRetryButton();
        
        // API接続テストを実行
        testApiConnection();
    });
}

function showExperimentButton() {
    console.log('【DEBUG】showExperimentButton 呼び出し');
    const experimentButtonSection = document.getElementById('experimentButtonSection');
    if (experimentButtonSection) {
        experimentButtonSection.style.display = 'block';
        // スクロールして見やすく
        setTimeout(() => {
            experimentButtonSection.scrollIntoView({ behavior: 'smooth' });
        }, 300);
    }
}

function getSummary() {
    console.log('【DEBUG】getSummary 呼び出し');
    document.getElementById('summaryButton').disabled = true;
    
    fetch('/summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('【DEBUG】/summary レスポンス受信:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('【DEBUG】要約データ:', data);
        if (data.error) {
            alert('エラーが発生しました: ' + data.error);
        } else {
            console.log('【DEBUG】要約を表示します:', data.summary);
            document.getElementById('summaryContent').textContent = data.summary;
            document.getElementById('summarySection').style.display = 'block';
            document.getElementById('summaryButton').style.display = 'none';
            
            // スクロールして要約セクションを見やすく
            setTimeout(() => {
                document.getElementById('summarySection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }
        document.getElementById('summaryButton').disabled = false;
    })
    .catch(error => {
        console.error('【DEBUG】Error:', error);
        alert('通信エラーが発生しました。');
        document.getElementById('summaryButton').disabled = false;
    });
}

// 入力モード切り替え
function switchInputMode() {
    const mode = document.querySelector('input[name="inputMode"]:checked').id;
    const toggleSwitch = document.getElementById('toggleInputAssist');
    
    const touchKeyboard = document.getElementById('touchKeyboard');
    const keyboardArea = document.getElementById('keyboardArea');
    
    if (mode === 'modeKeyboard') {
        // キーボードモードでは50音表を非表示
        keyboardArea.style.display = 'none';
        toggleSwitch.checked = false;
    } else if (mode === 'mode50on') {
        // 50音表モード
        touchKeyboard.style.display = 'block';
        keyboardArea.style.display = 'block';
        toggleSwitch.checked = true;
    }
}

</script>
{% endblock %}
