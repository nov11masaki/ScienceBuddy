{% extends "base.html" %}

{% block title %}å­¦ç¿’ãƒ­ã‚°ä¸€è¦§{% endblock %}

{% block content %}
<div class="teacher-logs">
    <div class="container">
        <div class="logs-header mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">
                    <i class="fas fa-clipboard-list text-primary"></i>
                    å­¦ç¿’ãƒ­ã‚°ä¸€è¦§
                </h2>
                <div class="teacher-info">
                    <span class="badge bg-success me-2">{{ teacher_id }}</span>
                    <a href="/teacher/logout" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </a>
                </div>
            </div>
            
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="filters-section mb-4">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">æ—¥ä»˜</label>
                        <select class="form-select" id="dateFilter" onchange="applyFilters()">
                            {% for date_info in available_dates %}
                            <option value="{{ date_info.raw }}" {% if current_date == date_info.raw %}selected{% endif %}>
                                {{ date_info.formatted }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">å˜å…ƒ</label>
                        <select class="form-select" id="unitFilter" onchange="applyFilters()">
                            <option value="">ã™ã¹ã¦ã®å˜å…ƒ</option>
                            {% for unit in units %}
                            <option value="{{ unit }}" {% if current_unit == unit %}selected{% endif %}>
                                {{ unit }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">ã‚¯ãƒ©ã‚¹</label>
                        <select class="form-control" id="classFilter" onchange="applyFilters()">
                            <option value="">å…¨ã¦</option>
                            <option value="1" {% if current_class == '1' %}selected{% endif %}>1çµ„</option>
                            <option value="2" {% if current_class == '2' %}selected{% endif %}>2çµ„</option>
                            <option value="3" {% if current_class == '3' %}selected{% endif %}>3çµ„</option>
                            <option value="4" {% if current_class == '4' %}selected{% endif %}>4çµ„</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">å‡ºå¸­ç•ªå·</label>
                        <input type="number" class="form-control" id="studentFilter" 
                               placeholder="å‡ºå¸­ç•ªå·" min="1" max="30"
                               value="{{ current_student }}" onchange="applyFilters()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-eraser me-2"></i>ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å…ç«¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
        {% if students_data %}
        <div class="students-grid">
            {% for student_number, student_data in students_data.items() %}
            <div class="student-card">
                <div class="student-header">
                    <h4>
                        <i class="fas fa-user-graduate"></i>
                        {% if student_data.student_info %}
                            {{ student_data.student_info.display }}
                            <span class="student-id-badge">(ID: {{ student_number }})</span>
                        {% else %}
                            {{ student_number }}ç•ª
                        {% endif %}
                    </h4>
                </div>
                
                <div class="units-list">
                    {% for unit_name, unit_data in student_data.units.items() %}
                    <div class="unit-item">
                        <div class="unit-header">
                            <h6 class="unit-name">{{ unit_name }}</h6>
                            <div class="progress-indicators">
                                {% if unit_data.prediction_chats %}
                                    <span class="badge bg-info" title="äºˆæƒ³å¯¾è©±">
                                        <i class="fas fa-comments"></i> {{ unit_data.prediction_chats|length }}
                                    </span>
                                {% endif %}
                                {% if unit_data.prediction_summary %}
                                    <span class="badge bg-primary" title="äºˆæƒ³ã¾ã¨ã‚">
                                        <i class="fas fa-brain"></i>
                                    </span>
                                {% endif %}
                                {% if unit_data.reflection_chats %}
                                    <span class="badge bg-warning" title="è€ƒå¯Ÿå¯¾è©±">
                                        <i class="fas fa-lightbulb"></i> {{ unit_data.reflection_chats|length }}
                                    </span>
                                {% endif %}
                                {% if unit_data.final_summary %}
                                    <span class="badge bg-success" title="æœ€çµ‚è€ƒå¯Ÿ">
                                        <i class="fas fa-check"></i>
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="unit-actions">
                            <a href="/teacher/student_detail?class={{ student_data.student_info.class_num }}&seat={{ student_data.student_info.seat_num }}&unit={{ unit_name|urlencode }}" 
                               class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> è©³ç´°
                            </a>
                            <div class="btn-group" role="group">
                                <button id="btnGroupDrop{{ loop.index }}" type="button" class="btn btn-sm btn-outline-danger dropdown-toggle" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-trash"></i> å‰Šé™¤
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="btnGroupDrop{{ loop.index }}">
                                    <li>
                                        <a class="dropdown-item" href="#" 
                                           onclick="deleteLog('{{ student_data.student_info.class_num }}', '{{ student_data.student_info.seat_num }}', '{{ unit_name }}', '{{ current_date }}', 'unit'); return false;">
                                            <i class="fas fa-book me-2"></i>ã“ã®ãƒ¦ãƒ‹ãƒƒãƒˆã‚’å‰Šé™¤
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" 
                                           onclick="deleteLog('{{ student_data.student_info.class_num }}', '{{ student_data.student_info.seat_num }}', '', '{{ current_date }}', 'student'); return false;">
                                            <i class="fas fa-user me-2"></i>ã“ã®å­¦ç”Ÿã®å…¨ãƒ­ã‚°ã‚’å‰Šé™¤
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" 
                                           onclick="deleteLog(null, null, '', '{{ current_date }}', 'all'); return false;">
                                            <i class="fas fa-exclamation-triangle me-2"></i>ã“ã®æ—¥ä»˜ã®å…¨ãƒ­ã‚°ã‚’å‰Šé™¤
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- äºˆæƒ³ã¾ã¨ã‚ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º -->
                        {% if unit_data.prediction_summary %}
                        <div class="summary-preview">
                            <small class="text-muted">äºˆæƒ³:</small>
                            <p class="mb-1">{{ unit_data.prediction_summary.data.summary[:100] }}
                            {% if unit_data.prediction_summary.data.summary|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}
                        
                        <!-- æœ€çµ‚è€ƒå¯ŸãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º -->
                        {% if unit_data.final_summary %}
                        <div class="summary-preview">
                            <small class="text-muted">è€ƒå¯Ÿ:</small>
                            <p class="mb-0">{{ unit_data.final_summary.data.final_summary[:100] }}
                            {% if unit_data.final_summary.data.final_summary|length > 100 %}...{% endif %}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h4>
            <p class="text-muted">æŒ‡å®šã—ãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å­¦ç¿’ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        </div>
        {% endif %}
        
        <div class="text-center mt-5">
            <a href="/teacher/dashboard" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left me-2"></i>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
            </a>
            <button class="btn btn-success" onclick="exportCurrentData()">
                <i class="fas fa-download me-2"></i>ç¾åœ¨ã®è¡¨ç¤ºã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    let url = '/teacher/logs?';
    const params = [];
    
    const date = document.getElementById('dateFilter').value;
    const unit = document.getElementById('unitFilter').value;
    const classNum = document.getElementById('classFilter').value;
    const student = document.getElementById('studentFilter').value;
    
    if (date) params.push(`date=${date}`);
    if (unit) params.push(`unit=${encodeURIComponent(unit)}`);
    if (classNum) params.push(`class=${classNum}`);
    if (student) params.push(`student=${student}`);
    
    url += params.join('&');
    window.location.href = url;
}

function clearFilters() {
    const dateSelect = document.getElementById('dateFilter');
    if (dateSelect.options.length > 0) {
        dateSelect.selectedIndex = 0;
    }
    document.getElementById('unitFilter').value = '';
    document.getElementById('classFilter').value = '';
    document.getElementById('studentFilter').value = '';
    applyFilters();
}

function exportCurrentData() {
    const date = document.getElementById('dateFilter').value;
    
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨
    const link = document.createElement('a');
    link.href = `/teacher/export?date=${date}`;
    link.download = `learning_logs_${date}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥
    setTimeout(() => {
        alert(`ğŸ“¥ ${date} ã®ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚`);
    }, 500);
}

function deleteLog(classNum, seatNum, unit, date, deleteType) {
    // deleteType: 'unit' (å˜å…ƒå‰Šé™¤), 'student' (å­¦ç”Ÿå…¨å‰Šé™¤), 'all' (æ—¥ä»˜å…¨å‰Šé™¤)
    deleteType = deleteType || 'unit';
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
    const password = prompt('ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (password === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    if (password !== 'RIKA') {
        alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™');
        return;
    }
    
    let confirmMsg = '';
    let warningMsg = '';
    
    if (deleteType === 'all') {
        warningMsg = `âš ï¸ è­¦å‘Š: ${date} ã®ã™ã¹ã¦ã®ãƒ­ã‚°ï¼ˆå…¨å­¦ç”Ÿãƒ»å…¨å˜å…ƒï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼`;
        confirmMsg = 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿç¢ºèªã®ãŸã‚ã€Œå…¨å‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:';
        if (!confirm(warningMsg)) return;
        if (prompt(confirmMsg) !== 'å…¨å‰Šé™¤') {
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
            return;
        }
    } else if (deleteType === 'student') {
        warningMsg = `${classNum}çµ„${seatNum}ç•ª ã®å…¨ãƒ­ã‚°ï¼ˆå…¨å˜å…ƒï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
        confirmMsg = 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿç¢ºèªã®ãŸã‚ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:';
        if (!confirm(warningMsg)) return;
        if (prompt(confirmMsg) !== 'å‰Šé™¤') {
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
            return;
        }
    } else {
        // unitï¼ˆå˜å…ƒå‰Šé™¤ï¼‰
        warningMsg = `${classNum}çµ„${seatNum}ç•ª ã®ã€Œ${unit}ã€ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`;
        confirmMsg = 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿç¢ºèªã®ãŸã‚ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:';
        if (!confirm(warningMsg)) return;
        if (prompt(confirmMsg) !== 'å‰Šé™¤') {
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚');
            return;
        }
    }
    
    const data = {
        class_num: classNum ? parseInt(classNum) : null,
        seat_num: seatNum ? parseInt(seatNum) : null,
        unit: unit || '',
        date: date
    };
    
    fetch('/teacher/delete_log', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«é–¢ã‚ã‚‰ãšã€ã¾ãšãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ JSON ã¨ã—ã¦èª­ã‚€
        return response.json().then(json => {
            return {
                ok: response.ok,
                status: response.status,
                data: json
            };
        });
    })
    .then(result => {
        if (result.ok) {
            alert(result.data.message || 'ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.reload();
        } else {
            // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å†…å®¹ã‚’è¡¨ç¤º
            const errorMsg = result.data.error || `ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${result.status}ï¼‰`;
            console.error('Delete error:', result.data);
            alert(`ãƒ­ã‚°å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${errorMsg}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ãƒ­ã‚°å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
    });
}
</script>
{% endblock %}
