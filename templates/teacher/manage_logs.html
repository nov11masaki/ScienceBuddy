{% extends "base.html" %}

{% block title %}ãƒ­ã‚°ç®¡ç†{% endblock %}

{% block content %}
<div class="teacher-manage-logs">
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="fas fa-database text-primary"></i>
                ãƒ­ã‚°ç®¡ç†
            </h2>
            <div>
                <a href="/teacher/logs" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left"></i> ãƒ­ã‚°ä¸€è¦§ã«æˆ»ã‚‹
                </a>
                <a href="/teacher/logout" class="btn btn-outline-secondary">
                    <i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
            </div>
        </div>

        <!-- ã‚¿ãƒ– -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="delete-tab" data-bs-toggle="tab" data-bs-target="#delete-panel" type="button">
                    <i class="fas fa-trash"></i> ãƒ­ã‚°å‰Šé™¤
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-panel" type="button">
                    <i class="fas fa-chart-bar"></i> ãƒ­ã‚°çµ±è¨ˆ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-panel" type="button">
                    <i class="fas fa-download"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- å‰Šé™¤ãƒ‘ãƒãƒ« -->
            <div class="tab-pane fade show active" id="delete-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> ãƒ­ã‚°å‰Šé™¤</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning" role="alert">
                            <strong>âš ï¸ æ³¨æ„:</strong> å‰Šé™¤ã—ãŸãƒ­ã‚°ã¯å¾©æ—§ã§ãã¾ã›ã‚“ã€‚å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <h5>ç‰¹å®šæ—¥ä»˜ã®ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤</h5>
                                <div class="mb-3">
                                    <label class="form-label">æ—¥ä»˜ã‚’é¸æŠ:</label>
                                    <select id="deleteDate" class="form-select">
                                        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                                        {% for stat in log_stats %}
                                        <option value="{{ stat.date.raw }}">
                                            {{ stat.date.formatted }} 
                                            (ãƒ¦ãƒ¼ã‚¶: {{ stat.user_count }}, ãƒ­ã‚°: {{ stat.log_count }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <button class="btn btn-danger" onclick="deleteAllLogsForDate()">
                                    <i class="fas fa-trash"></i> ã“ã®æ—¥ä»˜ã®ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤
                                </button>
                            </div>

                            <div class="col-md-6">
                                <h5>å¤ã„ãƒ­ã‚°ã‚’ä¸€æ‹¬å‰Šé™¤</h5>
                                <div class="mb-3">
                                    <label class="form-label">ã“ã®æ—¥ä»˜ã‚ˆã‚Šå‰ã®ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤:</label>
                                    <input type="date" id="deleteBefore" class="form-control">
                                </div>
                                <button class="btn btn-danger" onclick="deleteOldLogs()">
                                    <i class="fas fa-trash"></i> å¤ã„ãƒ­ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤
                                </button>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h5>å€‹åˆ¥å‰Šé™¤</h5>
                        <p class="text-muted">ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯å˜å…ƒã®ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹å ´åˆã¯ã€<a href="/teacher/logs">ãƒ­ã‚°ä¸€è¦§</a>ã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
            <div class="tab-pane fade" id="stats-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> ãƒ­ã‚°çµ±è¨ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ—¥ä»˜</th>
                                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</th>
                                        <th>ç·ãƒ­ã‚°æ•°</th>
                                        <th>äºˆæƒ³ãƒãƒ£ãƒƒãƒˆ</th>
                                        <th>è€ƒå¯Ÿãƒãƒ£ãƒƒãƒˆ</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for stat in log_stats %}
                                    <tr>
                                        <td>
                                            <strong>{{ stat.date.formatted }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ stat.user_count }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ stat.log_count }}</span>
                                        </td>
                                        <td>{{ stat.prediction_chats }}</td>
                                        <td>{{ stat.reflection_chats }}</td>
                                        <td>
                                            <a href="/teacher/logs?date={{ stat.date.raw }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> è¡¨ç¤º
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ« -->
            <div class="tab-pane fade" id="export-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-download"></i> ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h5>
                                <p>ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                                <select id="exportDateCsv" class="form-select mb-3">
                                    <option value="">-- æœ€æ–°ã®ãƒ­ã‚°ã¾ã§ --</option>
                                    {% for date_info in available_dates %}
                                    <option value="{{ date_info.raw }}">
                                        {{ date_info.formatted }} ã¾ã§ã®ãƒ­ã‚°
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-success" onclick="exportCsv()">
                                    <i class="fas fa-file-csv"></i> CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                            </div>

                            <div class="col-md-6">
                                <h5>JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h5>
                                <p>å¯¾è©±å†…å®¹ã‚’JSONå½¢å¼ï¼ˆZIPï¼‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                                <select id="exportDateJson" class="form-select mb-3">
                                    <option value="">-- æœ€æ–°ã®ãƒ­ã‚°ã¾ã§ --</option>
                                    {% for date_info in available_dates %}
                                    <option value="{{ date_info.raw }}">
                                        {{ date_info.formatted }} ã¾ã§ã®ãƒ­ã‚°
                                    </option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-success" onclick="exportJson()">
                                    <i class="fas fa-file-code"></i> JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-info mt-4" role="alert">
            <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong>
            <ul class="mb-0">
                <li>å‰Šé™¤å‰ã«å¿…ãšCSVãƒ»JSONå½¢å¼ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„</li>
                <li>å¤§é‡å‰Šé™¤ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™</li>
                <li>å€‹åˆ¥å‰Šé™¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å˜ä½ï¼‰ã¯ã€Œãƒ­ã‚°ä¸€è¦§ã€ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„</li>
            </ul>
        </div>
    </div>
</div>

<style>
.teacher-manage-logs {
    background-color: #f8f9fa;
    min-height: 100vh;
    padding-bottom: 2rem;
}

.table-hover tbody tr:hover {
    background-color: #f5f5f5 !important;
}

.badge {
    font-size: 0.9rem;
    padding: 0.4rem 0.6rem;
}
</style>

<script>
function deleteAllLogsForDate() {
    const date = document.getElementById('deleteDate').value;
    
    if (!date) {
        alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const confirmMsg = `${date.substring(0, 4)}å¹´${date.substring(4, 6)}æœˆ${date.substring(6, 8)}æ—¥ã®ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    
    if (!confirm(confirmMsg)) {
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
    }
    
    if (prompt('ç¢ºèªã®ãŸã‚ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„:') !== 'å‰Šé™¤') {
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
    }
    
    fetch('/api/teacher/delete_all_logs_for_date', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ date: date })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ“ ${data.deleted_count} ä»¶ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            location.reload();
        } else {
            alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
}

function deleteOldLogs() {
    const date = document.getElementById('deleteBefore').value;
    
    if (!date) {
        alert('å‰Šé™¤å¯¾è±¡ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    
    const dateObj = new Date(date);
    const formattedDate = dateObj.toISOString().split('T')[0].replace(/-/g, '');
    
    const confirmMsg = `${dateObj.toLocaleDateString('ja-JP')} ã‚ˆã‚Šå‰ã®ã™ã¹ã¦ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n\næœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    
    if (!confirm(confirmMsg)) {
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
    }
    
    alert('ã“ã®æ©Ÿèƒ½ã¯å®Ÿè£…æº–å‚™ä¸­ã§ã™ã€‚å€‹åˆ¥å‰Šé™¤ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
}

function exportCsv() {
    const date = document.getElementById('exportDateCsv').value || new Date().toISOString().split('T')[0].replace(/-/g, '');
    window.location.href = `/teacher/export?date=${date}`;
}

function exportJson() {
    const date = document.getElementById('exportDateJson').value || new Date().toISOString().split('T')[0].replace(/-/g, '');
    window.location.href = `/teacher/export_json?date=${date}`;
}
</script>
{% endblock %}
