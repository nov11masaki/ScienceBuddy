{% extends "base.html" %}

{% block title %}æ€è€ƒå‚¾å‘åˆ†æ - æ•™å“¡ç”¨{% endblock %}

{% block content %}
<div class="teacher-analysis-page">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="teacher-header">
        <div class="header-container">
            <div class="header-title-section">
                <h1><i class="fas fa-brain"></i> æ€è€ƒå‚¾å‘åˆ†æ</h1>
                <p>ã‚¯ãƒ©ã‚¹ãƒ»å˜å…ƒã”ã¨ã®å…ç«¥ã®æ€è€ƒå‚¾å‘ã¨å­¦ç¿’çŠ¶æ³</p>
            </div>
            <div class="header-actions-section">
                <a href="/teacher/dashboard" class="btn btn-outline-secondary btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
                </a>
                <span class="teacher-id-badge"><i class="fas fa-user-tie"></i> {{ teacher_id }}</span>
                <a href="/teacher/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            </div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="analysis-main">
        <div class="container-fluid">
            <!-- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="analysis-overview">
                <h2><i class="fas fa-chart-pie"></i> åˆ†ææ¦‚è¦</h2>
                <div class="overview-cards">
                    <div class="overview-card">
                        <div class="card-value">{{ analysis_data|length }}</div>
                        <div class="card-label">ã‚¯ãƒ©ã‚¹æ•°</div>
                    </div>
                    <div class="overview-card">
                        {% set total_units = 0 %}
                        {% for class_num in analysis_data %}
                            {% set total_units = total_units + analysis_data[class_num]|length %}
                        {% endfor %}
                        <div class="card-value">{{ total_units }}</div>
                        <div class="card-label">å˜å…ƒæ•°</div>
                    </div>
                    <div class="overview-card">
                        {% set total_students = 0 %}
                        {% for class_num in analysis_data %}
                            {% for unit in analysis_data[class_num] %}
                                {% set total_students = total_students + analysis_data[class_num][unit]['total_students'] %}
                            {% endfor %}
                        {% endfor %}
                        <div class="card-value">{{ total_students }}</div>
                        <div class="card-label">é–¢ä¸å­¦ç”Ÿæ•°</div>
                    </div>
                </div>
            </section>

            <!-- ã‚¯ãƒ©ã‚¹åˆ¥åˆ†æ -->
            <section class="class-analysis">
                <h2><i class="fas fa-layer-group"></i> ã‚¯ãƒ©ã‚¹åˆ¥åˆ†æ</h2>
                
                {% for class_num in analysis_data|sort %}
                <div class="class-card">
                    <div class="class-header">
                        <h3>{{ class_num }}çµ„</h3>
                        <span class="badge bg-primary">{{ analysis_data[class_num]|length }}å˜å…ƒ</span>
                    </div>

                    <div class="units-grid">
                        {% for unit in analysis_data[class_num]|sort %}
                        {% set unit_data = analysis_data[class_num][unit] %}
                        <div class="unit-analysis-card">
                            <div class="unit-header">
                                <h4>{{ unit }}</h4>
                                <div class="unit-badges">
                                    <span class="badge engagement-{{ unit_data.engagement_level }}">
                                        {{ 
                                            'ğŸ”¥ é«˜æ´»ç™º' if unit_data.engagement_level == 'high'
                                            else 'âš ï¸ ä¸­ç¨‹åº¦' if unit_data.engagement_level == 'medium'
                                            else 'âŒ ä½æ´»ç™º'
                                        }}
                                    </span>
                                </div>
                            </div>

                            <div class="unit-stats">
                                <div class="stat">
                                    <span class="stat-label">å‚åŠ å­¦ç”Ÿæ•°</span>
                                    <span class="stat-value">{{ unit_data.total_students }}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">äºˆæƒ³å¯¾è©±</span>
                                    <span class="stat-value">{{ unit_data.prediction_count }}</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-label">æŒ¯ã‚Šè¿”ã‚Šå¯¾è©±</span>
                                    <span class="stat-value">{{ unit_data.reflection_count }}</span>
                                </div>
                            </div>

                            <!-- AI åˆ†æçµæœ -->
                            {% if unit_data.ai_analysis %}
                            <div class="ai-analysis-section">
                                <h5><i class="fas fa-robot"></i> AIåˆ†æçµæœ</h5>
                                
                                <!-- ç†è§£åº¦ãƒ¬ãƒ™ãƒ« -->
                                <div class="analysis-item">
                                    <span class="analysis-label">ç†è§£åº¦ãƒ¬ãƒ™ãƒ«ï¼š</span>
                                    <span class="analysis-value understanding-{{ unit_data.ai_analysis.understanding_level }}">
                                        {{ unit_data.ai_analysis.understanding_level }}
                                    </span>
                                </div>
                                
                                <!-- æ€è€ƒå‚¾å‘ã®èª¬æ˜ -->
                                <div class="analysis-item">
                                    <span class="analysis-label">æ€è€ƒã®ç‰¹å¾´ï¼š</span>
                                    <p class="analysis-text">{{ unit_data.ai_analysis.thinking_characteristics }}</p>
                                </div>
                                
                                <!-- è³ªå•ã®è³ª -->
                                <div class="analysis-item">
                                    <span class="analysis-label">è³ªå•ã®è³ªï¼š</span>
                                    <p class="analysis-text">{{ unit_data.ai_analysis.question_quality }}</p>
                                </div>
                                
                                <!-- èª¤è§£ã¨æ”¹å–„ -->
                                <div class="analysis-item">
                                    <span class="analysis-label">ã‚ˆãã‚ã‚‹èª¤è§£ï¼š</span>
                                    <div class="misconceptions-list">
                                        {% if unit_data.ai_analysis.misconceptions %}
                                            {% for misconception in unit_data.ai_analysis.misconceptions %}
                                            <div class="misconception">âš ï¸ {{ misconception }}</div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="misconception">ç‰¹ã«èª¤è§£ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- å­¦ç¿’ã®å¼·ã¿ -->
                                <div class="analysis-item">
                                    <span class="analysis-label">å­¦ç¿’ã®å¼·ã¿ï¼š</span>
                                    <p class="analysis-text">{{ unit_data.ai_analysis.learning_strengths }}</p>
                                </div>
                                
                                <!-- æ”¹å–„ãŒå¿…è¦ãªç‚¹ -->
                                <div class="analysis-item">
                                    <span class="analysis-label">æ”¹å–„ãŒå¿…è¦ãªç‚¹ï¼š</span>
                                    <p class="analysis-text">{{ unit_data.ai_analysis.improvement_areas }}</p>
                                </div>
                                
                                <!-- æŒ‡å°ä¸Šã®å·¥å¤« -->
                                <div class="analysis-item highlighted">
                                    <span class="analysis-label">æŒ‡å°ä¸Šã®å·¥å¤«ï¼š</span>
                                    {% if unit_data.ai_analysis.teaching_recommendations is string %}
                                        <p class="analysis-text">{{ unit_data.ai_analysis.teaching_recommendations }}</p>
                                    {% else %}
                                        <ul class="teaching-list">
                                            {% for recommendation in unit_data.ai_analysis.teaching_recommendations %}
                                            <li>{{ recommendation }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </div>
                            </div>
                            {% else %}
                            <div class="alert alert-danger" style="margin: 15px 0;">
                                <i class="fas fa-exclamation-circle"></i>
                                <div>
                                    <strong>åˆ†æã‚¨ãƒ©ãƒ¼</strong>
                                    <p style="margin: 4px 0 0 0; font-size: 0.85rem;">ã“ã®ãƒ¦ãƒ‹ãƒƒãƒˆã®åˆ†æå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã€å¾Œã»ã©å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                                </div>
                            </div>
                            {% endif %}

                            <!-- ã‚µãƒ³ãƒ—ãƒ«å¯¾è©± -->
                            {% if unit_data.sample_chats %}
                            <div class="sample-chats">
                                <h5><i class="fas fa-comments"></i> ã‚µãƒ³ãƒ—ãƒ«å¯¾è©±</h5>
                                {% for chat in unit_data.sample_chats %}
                                <div class="chat-sample">
                                    <div class="user-q">
                                        <strong>Q:</strong>
                                        <p>{{ chat.user[:100] }}{% if chat.user|length > 100 %}...{% endif %}</p>
                                    </div>
                                    <div class="ai-a">
                                        <strong>A:</strong>
                                        <p>{{ chat.ai[:100] }}{% if chat.ai|length > 100 %}...{% endif %}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- è©³ç´°ãƒœã‚¿ãƒ³ -->
                            <div class="unit-actions">
                                <a href="/teacher/logs?class={{ class_num }}&unit={{ unit|urlencode }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-magnifying-glass"></i> è©³ç´°ã‚’è¦‹ã‚‹
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                {% if not analysis_data %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    å­¦ç¿’ãƒ­ã‚°ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚ç”Ÿå¾’ãŒå¯¾è©±ã‚’é€²ã‚ã‚‹ã¨ã€ã“ã“ã«åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
                {% endif %}
            </section>
        </div>
    </main>
</div>

<style>
.teacher-analysis-page {
    min-height: 100vh;
    background: #f5f5f5;
}

.analysis-main {
    padding: 40px 20px;
}

.container-fluid {
    max-width: 1400px;
    margin: 0 auto;
}

/* æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.analysis-overview {
    margin-bottom: 40px;
}

.analysis-overview h2 {
    font-size: 1.5rem;
    margin-bottom: 20px;
    color: #202124;
}

.overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.overview-card {
    background: white;
    border-radius: 12px;
    padding: 30px 20px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 90, 156, 0.12);
    border: 1px solid #d3d3d7;
}

.card-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #005A9C;
    margin-bottom: 10px;
}

.card-label {
    font-size: 0.9rem;
    color: #6c757d;
}

/* ã‚¯ãƒ©ã‚¹åˆ¥åˆ†æ */
.class-analysis h2 {
    font-size: 1.5rem;
    margin-bottom: 30px;
    color: #202124;
}

.class-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0, 90, 156, 0.12);
    border: 1px solid #d3d3d7;
}

.class-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e8eaed;
}

.class-header h3 {
    font-size: 1.3rem;
    margin: 0;
    color: #005A9C;
}

/* ãƒ¦ãƒ‹ãƒƒãƒˆåˆ†æã‚«ãƒ¼ãƒ‰ */
.units-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.unit-analysis-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #e8eaed;
    transition: all 0.3s ease;
}

.unit-analysis-card:hover {
    border-color: #005A9C;
    box-shadow: 0 4px 12px rgba(0, 90, 156, 0.15);
    transform: translateY(-2px);
}

.unit-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.unit-header h4 {
    margin: 0;
    color: #202124;
    font-size: 1.1rem;
    flex: 1;
}

.unit-badges {
    display: flex;
    gap: 8px;
}

.unit-badges .badge {
    font-size: 0.8rem;
    padding: 4px 8px;
    white-space: nowrap;
}

/* æ´»ç™ºåº¦ãƒãƒƒã‚¸ */
.badge.engagement-high {
    background-color: #00933e;
    color: white;
}

.badge.engagement-medium {
    background-color: #cc7000;
    color: white;
}

.badge.engagement-low {
    background-color: #d2170d;
    color: white;
}

.unit-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 15px;
    padding: 15px 0;
    border-top: 1px solid #e8eaed;
    border-bottom: 1px solid #e8eaed;
}

.stat {
    text-align: center;
}

.stat-label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #005A9C;
}

/* AIåˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.ai-analysis-section {
    background: #f0f7ff;
    border-left: 5px solid #005A9C;
    padding: 20px;
    margin: 18px 0;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 90, 156, 0.08);
}

.ai-analysis-section h5 {
    margin: 0 0 18px 0;
    color: #005A9C;
    font-size: 1.05rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
}

.analysis-item {
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid rgba(0, 90, 156, 0.1);
}

.analysis-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.analysis-item.highlighted {
    background: rgba(0, 147, 62, 0.08);
    padding: 12px 14px;
    border-radius: 6px;
    border-left: 4px solid #00933e;
    margin-bottom: 16px;
}

.analysis-label {
    display: inline-block;
    font-weight: 600;
    color: #003d6b;
    min-width: 140px;
    font-size: 0.95rem;
    vertical-align: top;
}

.analysis-value {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.9rem;
}

.analysis-value.understanding-åˆæœŸæ®µéš {
    background: #ffeaa7;
    color: #d63031;
}

.analysis-value.understanding-ç™ºå±•æ®µéš {
    background: #74b9ff;
    color: #0984e3;
}

.analysis-value.understanding-æ·±åŒ–æ®µéš {
    background: #55efc4;
    color: #00b894;
}

.analysis-text {
    display: block;
    margin: 8px 0 0 140px;
    color: #202124;
    line-height: 1.6;
    font-size: 0.95rem;
}

.thinking-patterns {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0 0 140px;
}

.pattern-tag {
    display: inline-block;
    background: #005A9C;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
}

.misconceptions-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.misconception {
    background: #ffe3e3;
    border-left: 3px solid #d2170d;
    padding: 10px 12px;
    border-radius: 4px;
    font-size: 0.9rem;
    color: #5c0a0a;
    margin: 4px 0;
}

.stat-label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #005A9C;
}

/* ã‚µãƒ³ãƒ—ãƒ«å¯¾è©± */
.sample-chats {
    margin: 15px 0;
    padding: 12px;
    background: #f7f8f9;
    border-radius: 8px;
    border-left: 3px solid #0074d9;
}

.sample-chats h5 {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    color: #005A9C;
}

.chat-sample {
    margin-bottom: 10px;
    font-size: 0.85rem;
}

.chat-sample:last-child {
    margin-bottom: 0;
}

.user-q, .ai-a {
    margin-bottom: 5px;
}

.user-q {
    background: #e3f2fd;
    padding: 8px;
    border-radius: 4px;
    border-left: 2px solid #005A9C;
}

.user-q strong {
    color: #003d6b;
}

.user-q p {
    margin: 4px 0 0 0;
    color: #202124;
}

.ai-a {
    background: #f1f8e9;
    padding: 8px;
    border-radius: 4px;
    border-left: 2px solid #00933e;
}

.ai-a strong {
    color: #005228;
}

.ai-a p {
    margin: 4px 0 0 0;
    color: #202124;
}

/* ãƒ¦ãƒ‹ãƒƒãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.unit-actions {
    margin-top: 12px;
    display: flex;
    gap: 8px;
}

.unit-actions .btn {
    flex: 1;
    text-align: center;
}

/* ã‚¢ãƒ©ãƒ¼ãƒˆ */
.alert {
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.alert i {
    font-size: 1.2rem;
    margin-top: 2px;
    flex-shrink: 0;
}

.alert-info {
    background: #e3f2fd;
    border: 2px solid #90caf9;
    color: #01579b;
    border-radius: 8px;
}

.alert-danger {
    background: #ffebee;
    border: 2px solid #ef5350;
    color: #c62828;
    border-radius: 8px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 768px) {
    .units-grid {
        grid-template-columns: 1fr;
    }
    
    .overview-cards {
        grid-template-columns: 1fr;
    }
    
    .unit-stats {
        grid-template-columns: 1fr;
    }
}

/* æŒ‡å°ä¸Šã®å·¥å¤«ãƒªã‚¹ãƒˆ */
.teaching-list {
    margin: 8px 0;
    padding-left: 20px;
    list-style: none;
}

.teaching-list li {
    margin: 6px 0;
    padding-left: 24px;
    position: relative;
    color: #202124;
    line-height: 1.5;
}

.teaching-list li:before {
    content: "âœ“";
    position: absolute;
    left: 0;
    color: #00933e;
    font-weight: bold;
}
</style>

{% endblock %}
