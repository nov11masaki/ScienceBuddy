{% extends "base.html" %}

{% block title %}考察をまとめよう{% endblock %}

{% block content %}
<div class="chat-page-vertical">
    <div class="container-fluid h-100">
        <!-- 上半分: 対話画面 -->
        <div class="chat-section">
            <div class="chat-header text-center mb-2">
                <h2 class="mb-2">
                    <i class="fas fa-lightbulb text-primary"></i>
                    考察をまとめよう
                </h2>
                <div class="unit-display">
                    <span class="badge bg-primary fs-6">{{ unit }}</span>
                </div>
            </div>
            
            <div class="prediction-review mb-2">
                <div class="review-card">
                    <h5 class="review-title">
                        <i class="fas fa-brain"></i>
                        あなたの予想
                    </h5>
                    <p class="review-content">{{ prediction_summary or '予想が記録されていません。' }}</p>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="reflectionMessages">
                    <!-- 初期メッセージ -->
                    <div class="message ai-message">
                        <div class="message-avatar"></div>
                        <div class="message-content">
                            {{ initial_ai_message }}
                        </div>
                    </div>
                    
                    <!-- 入力エリア（直接入力可能） -->
                    <div class="message user-message user-input-area input-compact" style="margin-top: 12px;">
                        <div class="input-with-send">
                            <textarea class="user-input-bubble placeholder-input" id="reflectionInput" placeholder="ここに入力してください"></textarea>
                            <button class="send-button" id="sendButton" title="送信">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons text-center mt-2">
                <button class="btn btn-success" id="finalSummaryButton" style="display: none;">
                    <i class="fas fa-file-alt me-2"></i>
                    考察をまとめる
                </button>
            </div>
            
            <!-- チャット内で表示される学習完了ボタン -->
            <div class="text-center mt-3" id="completionSection" style="display: none;">
                <a href="/" class="btn btn-success btn-lg">
                    <i class="fas fa-home me-2"></i>
                    ホームに戻る
                </a>
            </div>
            
            <div class="summary-section" id="finalSummarySection" style="display: none;">
                <div class="summary-card">
                    <h5 class="summary-title">
                        <i class="fas fa-graduation-cap"></i>
                        最終考察
                    </h5>
                    <div class="summary-content" id="finalSummaryContent"></div>
                    <div class="text-center mt-3">
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-home me-2"></i>
                            ホームに戻る
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 下半分: 入力補助エリア -->
        <div class="input-assist-section" id="inputAssistSection">
            <div class="input-assist-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> 入力エリア
                    </h5>
                    <div class="input-mode-switches">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="toggle50on">
                            <label class="form-check-label" for="toggle50on">
                                50音表
                            </label>
                        </div>
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" id="toggleVoice">
                            <label class="form-check-label" for="toggleVoice">
                                音声入力
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 50音表キーボード -->
            <div class="keyboard-area-fullscreen" id="keyboardArea">
                <div class="touch-keyboard-panel" id="touchKeyboard">
                    <div class="keyboard-grid-vertical" id="hiraganaKeys">
                        <!-- JavaScriptで動的に生成 -->
                    </div>
                </div>
            </div>
            
            <!-- 入力コントロールエリア -->
            <div class="input-controls-area">
                <!-- 音声入力ボタン -->
                <div class="voice-input-section mb-2" id="voiceInputSection" style="display: none;">
                    <button class="btn btn-outline-primary w-100" id="voiceInputBtn">
                        <i class="fas fa-microphone"></i> 音声で入力
                    </button>
                    <div class="voice-input-status mt-2" id="voiceInputStatus" style="display: none;">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-microphone"></i>
                            <span id="voiceStatusText">音声を認識中...</span>
                        </div>
                    </div>
                </div>
                
                <!-- キーボードコントロールボタン -->
                <div class="d-flex gap-2">
                    <button class="btn btn-warning flex-fill" id="backspaceBtn">
                        <i class="fas fa-backspace"></i> 消す
                    </button>
                    <button class="btn btn-danger flex-fill" id="clearBtn">
                        <i class="fas fa-times"></i> 全消去
                    </button>
                    <button class="btn btn-success" id="inputAssistSendBtn" title="送信">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conversationCount = 0;
let reflectionCount = 0;
let recognition = null;

const currentUnit = "{{ unit }}";

// 入力補助用の設定（シンプルなひらがなのみ）
const inputAssistConfig = {
    hiragana: [
        // 右から左への伝統的な50音表配置（縦書き）
        ['わ', 'ら', 'や', 'ま', 'は', 'な', 'た', 'さ', 'か', 'あ'],
        ['', 'り', '', 'み', 'ひ', 'に', 'ち', 'し', 'き', 'い'],
        ['を', 'る', 'ゆ', 'む', 'ふ', 'ぬ', 'つ', 'す', 'く', 'う'],
        ['', 'れ', '', 'め', 'へ', 'ね', 'て', 'せ', 'け', 'え'],
        ['ん', 'ろ', 'よ', 'も', 'ほ', 'の', 'と', 'そ', 'こ', 'お'],
        // 小さい文字と記号（左から右へ）
        ['゛゜', 'っ', 'ゃ', 'ゅ', 'ょ', '、', '。', '！', '？', 'スペース']
    ]
};

// 濁点・半濁点変換マップ
const dakutenMap = {
    'か': 'が', 'き': 'ぎ', 'く': 'ぐ', 'け': 'げ', 'こ': 'ご',
    'さ': 'ざ', 'し': 'じ', 'す': 'ず', 'せ': 'ぜ', 'そ': 'ぞ',
    'た': 'だ', 'ち': 'ぢ', 'つ': 'づ', 'て': 'で', 'と': 'ど',
    'は': 'ば', 'ひ': 'び', 'ふ': 'ぶ', 'へ': 'べ', 'ほ': 'ぼ',
    'が': 'か', 'ぎ': 'き', 'ぐ': 'く', 'げ': 'け', 'ご': 'こ',
    'ざ': 'さ', 'じ': 'し', 'ず': 'す', 'ぜ': 'せ', 'ぞ': 'そ',
    'だ': 'た', 'ぢ': 'ち', 'づ': 'つ', 'で': 'て', 'ど': 'と',
    'ば': 'ぱ', 'び': 'ぴ', 'ぶ': 'ぷ', 'べ': 'ぺ', 'ぼ': 'ぽ',
    'ぱ': 'は', 'ぴ': 'ひ', 'ぷ': 'ふ', 'ぺ': 'へ', 'ぽ': 'ほ'
};

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 初期メッセージはHTMLに直接書かれているので、ここでは追加しない
    
    // デフォルトで50音表がOFFなので、入力補助エリアを縮小
    const inputAssistSection = document.getElementById('inputAssistSection');
    if (inputAssistSection) {
        inputAssistSection.classList.add('keyboard-off');
    }
    
    // 入力補助の初期化
    initializeInputAssist();
    
    // 50音表表示切り替えスイッチ
    const toggle50onSwitch = document.getElementById('toggle50on');
    if (toggle50onSwitch) {
        toggle50onSwitch.addEventListener('change', function() {
            const keyboardArea = document.getElementById('keyboardArea');
            const userInputArea = document.querySelector('.user-input-area');
            const inputAssistSection = document.getElementById('inputAssistSection');
            
            if (this.checked) {
                // 50音表を表示
                keyboardArea.style.display = 'flex';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-hidden', 'input-compact');
                    userInputArea.classList.add('keyboard-shown', 'input-normal');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-off');
                    inputAssistSection.classList.add('keyboard-on');
                }
            } else {
                // 50音表を非表示（入力エリア下降アニメーション + 縮小）
                keyboardArea.style.display = 'none';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-shown', 'input-normal');
                    userInputArea.classList.add('keyboard-hidden', 'input-compact');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-on');
                    inputAssistSection.classList.add('keyboard-off');
                }
            }
        });
    }
    
    // 音声入力切り替えスイッチ
    const toggleVoiceSwitch = document.getElementById('toggleVoice');
    if (toggleVoiceSwitch) {
        toggleVoiceSwitch.addEventListener('change', function() {
            const voiceSection = document.getElementById('voiceInputSection');
            if (this.checked) {
                voiceSection.style.display = 'block';
            } else {
                voiceSection.style.display = 'none';
                stopVoiceInput();
            }
        });
    }
    
    // 音声入力ボタン
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    if (voiceInputBtn) {
        voiceInputBtn.addEventListener('click', function() {
            console.log('voiceInputBtnがクリックされました (reflection.html)');
            startVoiceInput();
        });
    }
    
    // キーボードコントロールボタン
    const backspaceBtn = document.getElementById('backspaceBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    if (backspaceBtn) {
        backspaceBtn.addEventListener('click', function() {
            const input = document.getElementById('reflectionInput');
            if (input.value.length > 0) {
                input.value = input.value.slice(0, -1);
            }
            input.focus();
        });
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const input = document.getElementById('reflectionInput');
            input.value = '';
            input.focus();
        });
    }
    
    // Enterキーで送信
    document.getElementById('reflectionInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendReflection();
        }
    });
    
    // 送信ボタン（チャット入力エリア）
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendReflection);
    }
    
    // 送信ボタン（50音表エリア）
    const inputAssistSendBtn = document.getElementById('inputAssistSendBtn');
    if (inputAssistSendBtn) {
        inputAssistSendBtn.addEventListener('click', sendReflection);
    }
    
    // まとめボタン
    document.getElementById('finalSummaryButton').addEventListener('click', getFinalSummary);
});

// 入力補助の初期化
function initializeInputAssist() {
    // ひらがなキーボードを設定
    const hiraganaContainer = document.getElementById('hiraganaKeys');
    hiraganaContainer.innerHTML = '';
    
    inputAssistConfig.hiragana.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary touch-key';
            if (char === '') {
                // 空白セル
                btn.style.visibility = 'hidden';
                btn.textContent = ' ';
            } else if (char === '゛゜') {
                // 濁点・半濁点ボタン
                btn.textContent = '゛゜';
                btn.className = 'btn btn-outline-secondary touch-key special-key';
                btn.onclick = () => addDakuten();
            } else if (char === 'スペース') {
                // スペースボタン
                btn.textContent = 'スペース';
                btn.className = 'btn btn-outline-info touch-key space-key';
                btn.onclick = () => insertText(' ');
            } else if (char === '、' || char === '。' || char === '！' || char === '？') {
                // 記号ボタン
                btn.textContent = char;
                btn.className = 'btn btn-outline-secondary touch-key';
                btn.onclick = () => insertText(char);
            } else {
                // 通常のひらがなボタン
                btn.textContent = char;
                btn.onclick = () => insertText(char);
            }
            hiraganaContainer.appendChild(btn);
        });
    });
}

function insertText(text) {
    const input = document.getElementById('reflectionInput');
    input.value += text;
    input.focus();
}

function addDakuten() {
    const input = document.getElementById('reflectionInput');
    const text = input.value;
    if (text.length === 0) return;
    
    const lastChar = text[text.length - 1];
    if (dakutenMap[lastChar]) {
        input.value = text.slice(0, -1) + dakutenMap[lastChar];
    }
    input.focus();
}

function sendReflection() {
    const input = document.getElementById('reflectionInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ユーザーメッセージを表示
    addReflectionMessage(message, 'user');
    input.value = '';
    
    // APIリクエストデータ
    const requestData = { 
        message: message
    };
    
    // AIの応答を取得
    fetch('/reflect_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTPエラー: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            addReflectionMessage('エラーが発生しました: ' + data.error, 'ai');
        } else {
            addReflectionMessage(data.response, 'ai');
            reflectionCount++;
            
            // AIのメッセージが「まとめ」に関する内容だったら、要約ボタンを表示
            if (data.response.includes('まとめ')) {
                console.log('【DEBUG】最終要約ボタンを表示します');
                document.getElementById('finalSummaryButton').style.display = 'block';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addReflectionMessage('通信エラーが発生しました: ' + error.message, 'ai');
    });
}

function addReflectionMessage(content, type) {
    const messagesContainer = document.getElementById('reflectionMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    messageDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
            ${content}
        </div>
    `;
    
    // 入力エリアを取得
    const inputArea = document.querySelector('.user-input-area');
    
    // メッセージを追加
    if (inputArea) {
        // 入力エリアの前に追加（入力エリアが最後に来るように）
        messagesContainer.insertBefore(messageDiv, inputArea);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showCompletionMessage() {
    console.log('【DEBUG】showCompletionMessage 呼び出し');
    const completionSection = document.getElementById('completionSection');
    if (completionSection) {
        completionSection.style.display = 'block';
        // スクロールして見やすく
        setTimeout(() => {
            completionSection.scrollIntoView({ behavior: 'smooth' });
        }, 300);
    }
}

function getFinalSummary() {
    console.log('【DEBUG】getFinalSummary 呼び出し');
    document.getElementById('finalSummaryButton').disabled = true;
    
    fetch('/final_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('【DEBUG】/final_summary レスポンス受信:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('【DEBUG】最終要約データ:', data);
        if (data.error) {
            alert('エラーが発生しました: ' + data.error);
        } else {
            console.log('【DEBUG】最終要約を表示します:', data.summary);
            document.getElementById('finalSummaryContent').textContent = data.summary;
            document.getElementById('finalSummarySection').style.display = 'block';
            document.getElementById('finalSummaryButton').style.display = 'none';
            
            // スクロールして要約セクションを見やすく
            setTimeout(() => {
                document.getElementById('finalSummarySection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }
        document.getElementById('finalSummaryButton').disabled = false;
    })
    .catch(error => {
        console.error('【DEBUG】Error:', error);
        alert('通信エラーが発生しました。');
        document.getElementById('finalSummaryButton').disabled = false;
    });
}

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('お使いのブラウザは音声入力に対応していません。Chrome、Edge、Safariをお使いください。');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (recognition && recognition.isListening) {
        stopVoiceInput();
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    const statusDiv = document.getElementById('voiceInputStatus');
    const statusText = document.getElementById('voiceStatusText');
    const voiceBtn = document.getElementById('voiceInputBtn');
    
    recognition.onstart = function() {
        recognition.isListening = true;
        statusDiv.style.display = 'block';
        statusText.textContent = '音声を認識中...';
        voiceBtn.classList.add('btn-danger');
        voiceBtn.classList.remove('btn-outline-primary');
        
        // 音声入力中はプレースホルダーテキストを非表示
        const placeholderText = document.getElementById('inputPlaceholderText');
        if (placeholderText) {
            placeholderText.style.display = 'none';
        }
    };
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        const input = document.getElementById('reflectionInput');
        const placeholderText = document.getElementById('inputPlaceholderText');
        
        if (interimTranscript) {
            statusText.textContent = '認識中: ' + interimTranscript;
            // プレースホルダーテキストにもリアルタイム表示
            if (placeholderText && input.value + interimTranscript) {
                placeholderText.textContent = input.value + interimTranscript;
            }
        }
        
        if (finalTranscript) {
            input.value += finalTranscript;
            statusText.textContent = '認識完了: ' + finalTranscript;
            // プレースホルダーテキストにもリアルタイム表示
            if (placeholderText && input.value) {
                placeholderText.textContent = input.value;
            }
        }
    };
    
    recognition.onerror = function(event) {
        console.error('音声認識エラー:', event.error);
        statusDiv.style.display = 'none';
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-primary');
        recognition.isListening = false;
        
        if (event.error === 'no-speech') {
            alert('音声が検出されませんでした。もう一度お試しください。');
        } else if (event.error === 'not-allowed') {
            alert('マイクの使用が許可されていません。ブラウザの設定を確認してください。');
        }
    };
    
    recognition.onend = function() {
        setTimeout(() => {
            statusDiv.style.display = 'none';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-primary');
            recognition.isListening = false;
            
            // プレースホルダーテキストを表示
            const placeholderText = document.getElementById('inputPlaceholderText');
            if (placeholderText) {
                placeholderText.style.display = 'block';
            }
        }, 1000);
    };
    
    recognition.start();
}

function stopVoiceInput() {
    if (recognition && recognition.isListening) {
        recognition.stop();
        recognition.isListening = false;
    }
}
</script>
{% endblock %}
