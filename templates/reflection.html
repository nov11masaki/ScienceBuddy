{% extends "base.html" %}

{% block title %}è€ƒå¯Ÿã‚’ã¾ã¨ã‚ã‚ˆã†{% endblock %}

{% block content %}
<div class="chat-page-vertical">
    <div class="container-fluid h-100">
        <!-- ä¸ŠåŠåˆ†: å¯¾è©±ç”»é¢ -->
        <div class="chat-section">
            <div class="chat-header text-center mb-2">
                <h2 class="mb-2">
                    <i class="fas fa-lightbulb text-primary"></i>
                    è€ƒå¯Ÿã‚’ã¾ã¨ã‚ã‚ˆã†
                </h2>
                <div class="unit-display">
                    <span class="badge bg-primary fs-6">{{ unit }}</span>
                </div>
            </div>
            
            <div class="prediction-review mb-2">
                <div class="review-card">
                    <h5 class="review-title">
                        <i class="fas fa-brain"></i>
                        ã‚ãªãŸã®äºˆæƒ³
                    </h5>
                    <p class="review-content">{{ prediction_summary or 'äºˆæƒ³ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚' }}</p>
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="reflectionMessages">
                    <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                    <div class="message ai-message">
                        <div class="message-avatar"></div>
                        <div class="message-content">
                            {{ initial_ai_message }}
                        </div>
                    </div>
                    
                    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆç›´æ¥å…¥åŠ›å¯èƒ½ï¼‰ -->
                    <div class="message user-message user-input-area input-compact" style="margin-top: 12px;">
                        <div class="user-input-wrapper">
                            <div class="input-with-send">
                                <textarea class="user-input-bubble placeholder-input" id="reflectionInput" placeholder="ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                                <button class="send-button" id="sendButton" title="é€ä¿¡">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons text-center mt-2">
                <button class="btn btn-success" id="finalSummaryButton" style="display: none;">
                    <i class="fas fa-file-alt me-2"></i>
                    è€ƒå¯Ÿã‚’ã¾ã¨ã‚ã‚‹
                </button>
            </div>
            
            <!-- ãƒãƒ£ãƒƒãƒˆå†…ã§è¡¨ç¤ºã•ã‚Œã‚‹å­¦ç¿’å®Œäº†ãƒœã‚¿ãƒ³ -->
            <div class="text-center mt-3" id="completionSection" style="display: none;">
                <a href="/" class="btn btn-success btn-lg">
                    <i class="fas fa-home me-2"></i>
                    ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </a>
            </div>
            
            <div class="summary-section" id="finalSummarySection" style="display: none;">
                <div class="summary-card">
                    <h5 class="summary-title">
                        <i class="fas fa-graduation-cap"></i>
                        æœ€çµ‚è€ƒå¯Ÿ
                    </h5>
                    <div class="summary-content" id="finalSummaryContent"></div>
                    <div class="text-center mt-3">
                        <a href="/" class="btn btn-primary">
                            <i class="fas fa-home me-2"></i>
                            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ä¸‹åŠåˆ†: å…¥åŠ›è£œåŠ©ã‚¨ãƒªã‚¢ -->
        <div class="input-assist-section" id="inputAssistSection">
            <div class="input-assist-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> å…¥åŠ›ã‚¨ãƒªã‚¢
                    </h5>
                    <div class="input-mode-switches">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="toggle50on">
                            <label class="form-check-label" for="toggle50on">
                                50éŸ³è¡¨
                            </label>
                        </div>
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" id="toggleVoice">
                            <label class="form-check-label" for="toggleVoice">
                                éŸ³å£°å…¥åŠ›
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 50éŸ³è¡¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ -->
            <div class="keyboard-area-fullscreen" id="keyboardArea" style="display: none;">
                <div class="touch-keyboard-panel" id="touchKeyboard">
                    <div class="keyboard-grid-vertical" id="hiraganaKeys">
                        <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <!-- å…¥åŠ›ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ -->
            <div class="input-controls-area">
                <!-- éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ -->
                <div class="voice-input-section mb-2" id="voiceInputSection" style="display: none;">
                    <button class="btn btn-outline-primary w-100" id="voiceInputBtn">
                        <i class="fas fa-microphone"></i> éŸ³å£°ã§å…¥åŠ›
                    </button>
                    <div class="voice-input-status mt-2" id="voiceInputStatus" style="display: none;">
                        <div class="alert alert-info mb-0 py-2">
                            <i class="fas fa-microphone"></i>
                            <span id="voiceStatusText">éŸ³å£°ã‚’èªè­˜ä¸­...</span>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="d-flex gap-2">
                    <button class="btn btn-warning flex-fill" id="backspaceBtn">
                        <i class="fas fa-backspace"></i> æ¶ˆã™
                    </button>
                    <button class="btn btn-danger flex-fill" id="clearBtn">
                        <i class="fas fa-times"></i> å…¨æ¶ˆå»
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- å¾©å¸°æƒ…å ±ã‚’JSONã¨ã—ã¦åŸ‹ã‚è¾¼ã¿ -->
<script type="application/json" id="resumption-info">{{ resumption_info | tojson | safe }}</script>

<!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆå¾©å¸°ç”¨ï¼‰ -->
<script type="application/json" id="reflection-session-data">
{
    "conversationHistory": {{ session.get('reflection_conversation', []) | tojson | safe }},
    "reflectionSummary": "{{ session.get('reflection_summary', '') | safe }}"
}
</script>

<script>
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptå¤‰æ•°ã«æ ¼ç´
const sessionDataElement = document.getElementById('reflection-session-data');
if (sessionDataElement) {
    const sessionData = JSON.parse(sessionDataElement.textContent);
    window.reflectionConversationHistory = sessionData.conversationHistory;
    window.reflectionSummary = sessionData.reflectionSummary;
}

const resumptionInfoElement = document.getElementById('resumption-info');
const reflectionResumptionInfo = resumptionInfoElement ? JSON.parse(resumptionInfoElement.textContent) : {is_resumption: false};

let reflectionExchangeCount = reflectionResumptionInfo.last_conversation_count || 0;
let recognition = null;

const currentUnit = "{{ unit }}";

// å…¥åŠ›è£œåŠ©ç”¨ã®è¨­å®šï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã²ã‚‰ãŒãªã®ã¿ï¼‰
const inputAssistConfig = {
    hiragana: [
        // å³ã‹ã‚‰å·¦ã¸ã®ä¼çµ±çš„ãª50éŸ³è¡¨é…ç½®ï¼ˆç¸¦æ›¸ãï¼‰
        ['ã‚', 'ã‚‰', 'ã‚„', 'ã¾', 'ã¯', 'ãª', 'ãŸ', 'ã•', 'ã‹', 'ã‚'],
        ['', 'ã‚Š', '', 'ã¿', 'ã²', 'ã«', 'ã¡', 'ã—', 'ã', 'ã„'],
        ['ã‚’', 'ã‚‹', 'ã‚†', 'ã‚€', 'ãµ', 'ã¬', 'ã¤', 'ã™', 'ã', 'ã†'],
        ['', 'ã‚Œ', '', 'ã‚', 'ã¸', 'ã­', 'ã¦', 'ã›', 'ã‘', 'ãˆ'],
        ['ã‚“', 'ã‚', 'ã‚ˆ', 'ã‚‚', 'ã»', 'ã®', 'ã¨', 'ã', 'ã“', 'ãŠ'],
        // å°ã•ã„æ–‡å­—ã¨è¨˜å·ï¼ˆå·¦ã‹ã‚‰å³ã¸ï¼‰
        ['ã‚›ã‚œ', 'ã£', 'ã‚ƒ', 'ã‚…', 'ã‚‡', 'ã€', 'ã€‚', 'ï¼', 'ï¼Ÿ', 'ã‚¹ãƒšãƒ¼ã‚¹']
    ]
};

// æ¿ç‚¹ãƒ»åŠæ¿ç‚¹å¤‰æ›ãƒãƒƒãƒ—
const dakutenMap = {
    'ã‹': 'ãŒ', 'ã': 'ã', 'ã': 'ã', 'ã‘': 'ã’', 'ã“': 'ã”',
    'ã•': 'ã–', 'ã—': 'ã˜', 'ã™': 'ãš', 'ã›': 'ãœ', 'ã': 'ã',
    'ãŸ': 'ã ', 'ã¡': 'ã¢', 'ã¤': 'ã¥', 'ã¦': 'ã§', 'ã¨': 'ã©',
    'ã¯': 'ã°', 'ã²': 'ã³', 'ãµ': 'ã¶', 'ã¸': 'ã¹', 'ã»': 'ã¼',
    'ãŒ': 'ã‹', 'ã': 'ã', 'ã': 'ã', 'ã’': 'ã‘', 'ã”': 'ã“',
    'ã–': 'ã•', 'ã˜': 'ã—', 'ãš': 'ã™', 'ãœ': 'ã›', 'ã': 'ã',
    'ã ': 'ãŸ', 'ã¢': 'ã¡', 'ã¥': 'ã¤', 'ã§': 'ã¦', 'ã©': 'ã¨',
    'ã°': 'ã±', 'ã³': 'ã´', 'ã¶': 'ã·', 'ã¹': 'ãº', 'ã¼': 'ã½',
    'ã±': 'ã¯', 'ã´': 'ã²', 'ã·': 'ãµ', 'ãº': 'ã¸', 'ã½': 'ã»'
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // å¾©å¸°æƒ…å ±ã‚’å–å¾—
    const resumptionInfo = reflectionResumptionInfo;
    
    if (resumptionInfo && resumptionInfo.is_resumption) {
        console.log('å¾©å¸°ãƒ¢ãƒ¼ãƒ‰: éå»ã®ä¼šè©±ã‚’å¾©å…ƒã—ã¾ã™', resumptionInfo);
        
        // éå»ã®ä¼šè©±ã‚’å¾©å…ƒ
        if (window.reflectionConversationHistory) {
            restoreReflectionConversation(window.reflectionConversationHistory);
        }
        
        // ã¾ã¨ã‚ãŒå®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯ã¾ã¨ã‚ã‚’å¾©å…ƒ
        if (resumptionInfo.reflection_summary_created && window.reflectionSummary) {
            showReflectionSummary(window.reflectionSummary);
        } else if ((resumptionInfo.last_conversation_count || 0) >= 2) {
            showFinalSummaryButton('å¾©å¸°æ™‚ã«è¦å®šå›æ•°é”æˆ');
        }
    }
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯HTMLã«ç›´æ¥æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯è¿½åŠ ã—ãªã„
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§50éŸ³è¡¨ãŒOFFãªã®ã§ã€å…¥åŠ›è£œåŠ©ã‚¨ãƒªã‚¢ã‚’ç¸®å°
    const inputAssistSection = document.getElementById('inputAssistSection');
    if (inputAssistSection) {
        inputAssistSection.classList.add('keyboard-off');
    }
    
    // å…¥åŠ›è£œåŠ©ã®åˆæœŸåŒ–
    initializeInputAssist();
    
    // 50éŸ³è¡¨è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ
    const toggle50onSwitch = document.getElementById('toggle50on');
    if (toggle50onSwitch) {
        toggle50onSwitch.addEventListener('change', function() {
            const keyboardArea = document.getElementById('keyboardArea');
            const userInputArea = document.querySelector('.user-input-area');
            const inputAssistSection = document.getElementById('inputAssistSection');
            
            if (this.checked) {
                // 50éŸ³è¡¨ã‚’è¡¨ç¤º
                keyboardArea.style.display = 'flex';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-hidden', 'input-compact');
                    userInputArea.classList.add('keyboard-shown', 'input-normal');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-off');
                    inputAssistSection.classList.add('keyboard-on');
                }
            } else {
                // 50éŸ³è¡¨ã‚’éè¡¨ç¤ºï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ä¸‹é™ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ç¸®å°ï¼‰
                keyboardArea.style.display = 'none';
                if (userInputArea) {
                    userInputArea.classList.remove('keyboard-shown', 'input-normal');
                    userInputArea.classList.add('keyboard-hidden', 'input-compact');
                }
                if (inputAssistSection) {
                    inputAssistSection.classList.remove('keyboard-on');
                    inputAssistSection.classList.add('keyboard-off');
                }
            }
        });
    }
    
    // éŸ³å£°å…¥åŠ›åˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ
    const toggleVoiceSwitch = document.getElementById('toggleVoice');
    if (toggleVoiceSwitch) {
        toggleVoiceSwitch.addEventListener('change', function() {
            const voiceSection = document.getElementById('voiceInputSection');
            if (this.checked) {
                voiceSection.style.display = 'block';
            } else {
                voiceSection.style.display = 'none';
                stopVoiceInput();
            }
        });
    }
    
    // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    if (voiceInputBtn) {
        voiceInputBtn.addEventListener('click', function() {
            console.log('voiceInputBtnãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ (reflection.html)');
            startVoiceInput();
        });
    }
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³
    const backspaceBtn = document.getElementById('backspaceBtn');
    const clearBtn = document.getElementById('clearBtn');
    
    if (backspaceBtn) {
        backspaceBtn.addEventListener('click', function() {
            const input = document.getElementById('reflectionInput');
            if (input.value.length > 0) {
                input.value = input.value.slice(0, -1);
            }
            input.focus();
        });
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            const input = document.getElementById('reflectionInput');
            input.value = '';
            input.focus();
        });
    }
    
    // Enterã‚­ãƒ¼ã§é€ä¿¡
    document.getElementById('reflectionInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendReflection();
        }
    });
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ï¼‰
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendReflection);
    }
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆ50éŸ³è¡¨ã‚¨ãƒªã‚¢ï¼‰
    const inputAssistSendBtn = document.getElementById('inputAssistSendBtn');
    if (inputAssistSendBtn) {
        inputAssistSendBtn.addEventListener('click', sendReflection);
    }
    
    // ã¾ã¨ã‚ãƒœã‚¿ãƒ³
    document.getElementById('finalSummaryButton').addEventListener('click', getFinalSummary);
});

function showFinalSummaryButton(reason) {
    if (reflectionResumptionInfo && reflectionResumptionInfo.reflection_summary_created) return;
    const button = document.getElementById('finalSummaryButton');
    if (!button) return;
    button.style.display = 'block';
    if (reason) {
        console.log('ã€DEBUGã€‘æœ€çµ‚è¦ç´„ãƒœã‚¿ãƒ³è¡¨ç¤º:', reason);
    }
}

// å…¥åŠ›è£œåŠ©ã®åˆæœŸåŒ–
function initializeInputAssist() {
    // ã²ã‚‰ãŒãªã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’è¨­å®š
    const hiraganaContainer = document.getElementById('hiraganaKeys');
    hiraganaContainer.innerHTML = '';
    
    inputAssistConfig.hiragana.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary touch-key';
            if (char === '') {
                // ç©ºç™½ã‚»ãƒ«
                btn.style.visibility = 'hidden';
                btn.textContent = ' ';
            } else if (char === 'ã‚›ã‚œ') {
                // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ãƒœã‚¿ãƒ³
                btn.textContent = 'ã‚›ã‚œ';
                btn.className = 'btn btn-outline-secondary touch-key special-key';
                btn.onclick = () => addDakuten();
            } else if (char === 'ã‚¹ãƒšãƒ¼ã‚¹') {
                // ã‚¹ãƒšãƒ¼ã‚¹ãƒœã‚¿ãƒ³
                btn.textContent = 'ã‚¹ãƒšãƒ¼ã‚¹';
                btn.className = 'btn btn-outline-info touch-key space-key';
                btn.onclick = () => insertText(' ');
            } else if (char === 'ã€' || char === 'ã€‚' || char === 'ï¼' || char === 'ï¼Ÿ') {
                // è¨˜å·ãƒœã‚¿ãƒ³
                btn.textContent = char;
                btn.className = 'btn btn-outline-secondary touch-key';
                btn.onclick = () => insertText(char);
            } else {
                // é€šå¸¸ã®ã²ã‚‰ãŒãªãƒœã‚¿ãƒ³
                btn.textContent = char;
                btn.onclick = () => insertText(char);
            }
            hiraganaContainer.appendChild(btn);
        });
    });
}

function insertText(text) {
    const input = document.getElementById('reflectionInput');
    input.value += text;
    input.focus();
}

// æ¿ç‚¹ãƒ»åŠæ¿éŸ³ã‚’è¿½åŠ ï¼ˆå¾ªç’°å¯¾å¿œï¼‰
function addDakuten() {
    const input = document.getElementById('reflectionInput');
    const text = input.value;
    if (text.length === 0) return;
    
    const lastChar = text[text.length - 1];
    
    // æ¿ç‚¹ãƒ»åŠæ¿ç‚¹ã®å¾ªç’°ãƒãƒƒãƒ—ï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ åŠæ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
    const dakutenCycleMap = {
        // ã‹è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã‹': 'ãŒ', 'ãŒ': 'ã‹',
        'ã': 'ã', 'ã': 'ã',
        'ã': 'ã', 'ã': 'ã',
        'ã‘': 'ã’', 'ã’': 'ã‘',
        'ã“': 'ã”', 'ã”': 'ã“',
        // ã•è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã•': 'ã–', 'ã–': 'ã•',
        'ã—': 'ã˜', 'ã˜': 'ã—',
        'ã™': 'ãš', 'ãš': 'ã™',
        'ã›': 'ãœ', 'ãœ': 'ã›',
        'ã': 'ã', 'ã': 'ã',
        // ãŸè¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ãŸ': 'ã ', 'ã ': 'ãŸ',
        'ã¡': 'ã¢', 'ã¢': 'ã¡',
        'ã¤': 'ã¥', 'ã¥': 'ã¤',
        'ã¦': 'ã§', 'ã§': 'ã¦',
        'ã¨': 'ã©', 'ã©': 'ã¨',
        // ã¯è¡Œï¼ˆæ¸…éŸ³ â†’ æ¿éŸ³ â†’ åŠæ¿éŸ³ â†’ æ¸…éŸ³ï¼‰
        'ã¯': 'ã°', 'ã°': 'ã±', 'ã±': 'ã¯',
        'ã²': 'ã³', 'ã³': 'ã´', 'ã´': 'ã²',
        'ãµ': 'ã¶', 'ã¶': 'ã·', 'ã·': 'ãµ',
        'ã¸': 'ã¹', 'ã¹': 'ãº', 'ãº': 'ã¸',
        'ã»': 'ã¼', 'ã¼': 'ã½', 'ã½': 'ã»'
    };
    
    // å¾ªç’°ãƒãƒƒãƒ—ã«å­˜åœ¨ã™ã‚Œã°å¤‰æ›
    if (dakutenCycleMap[lastChar]) {
        input.value = text.slice(0, -1) + dakutenCycleMap[lastChar];
    }
    
    input.focus();
}

function sendReflection() {
    const input = document.getElementById('reflectionInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addReflectionMessage(message, 'user');
    input.value = '';
    
    // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    const requestData = { 
        message: message
    };
    
    // AIã®å¿œç­”ã‚’å–å¾—
    fetch('/reflect_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            addReflectionMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error, 'ai', false);
        } else {
            addReflectionMessage(data.response, 'ai', true); // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆæœ‰åŠ¹
            reflectionExchangeCount++;
            
            if (data.suggest_final_summary || reflectionExchangeCount >= 2 || data.response.includes('ã¾ã¨ã‚') || data.response.includes('è¦ç´„')) {
                showFinalSummaryButton(`ä¼šè©±å›æ•°:${reflectionExchangeCount} / suggest:${data.suggest_final_summary}`);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addReflectionMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'ai', false);
    });
}

function addReflectionMessage(content, type, useTypingEffect = false) {
    const messagesContainer = document.getElementById('reflectionMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'message-avatar';
    
    messageDiv.appendChild(avatarDiv);
    messageDiv.appendChild(contentDiv);
    
    // å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’å–å¾—
    const inputArea = document.querySelector('.user-input-area');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    if (inputArea) {
        // å…¥åŠ›ã‚¨ãƒªã‚¢ã®å‰ã«è¿½åŠ ï¼ˆå…¥åŠ›ã‚¨ãƒªã‚¢ãŒæœ€å¾Œã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
        messagesContainer.insertBefore(messageDiv, inputArea);
    } else {
        messagesContainer.appendChild(messageDiv);
    }
    
    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼ˆAIå¿œç­”ã®ã¿ï¼‰
    if (useTypingEffect && type === 'ai') {
        typeReflectionMessage(contentDiv, content, messagesContainer);
    } else {
        contentDiv.innerHTML = content;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•°
function typeReflectionMessage(element, text, container) {
    let index = 0;
    const speed = 30; // ãƒŸãƒªç§’å˜ä½ï¼ˆæ•°å€¤ãŒå°ã•ã„ã»ã©é€Ÿã„ï¼‰
    
    // ã‚«ãƒ¼ã‚½ãƒ«ã‚’è¿½åŠ 
    const cursor = document.createElement('span');
    cursor.className = 'typing-cursor';
    cursor.textContent = 'â–Œ';
    element.appendChild(cursor);
    
    function typeChar() {
        if (index < text.length) {
            // ã‚«ãƒ¼ã‚½ãƒ«ã®å‰ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
            const textNode = document.createTextNode(text.charAt(index));
            element.insertBefore(textNode, cursor);
            index++;
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            container.scrollTop = container.scrollHeight;
            
            setTimeout(typeChar, speed);
        } else {
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†å¾Œã€ã‚«ãƒ¼ã‚½ãƒ«ã‚’å‰Šé™¤
            cursor.remove();
        }
    }
    
    typeChar();
}

function showCompletionMessage() {
    console.log('ã€DEBUGã€‘showCompletionMessage å‘¼ã³å‡ºã—');
    const completionSection = document.getElementById('completionSection');
    if (completionSection) {
        completionSection.style.display = 'block';
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦‹ã‚„ã™ã
        setTimeout(() => {
            completionSection.scrollIntoView({ behavior: 'smooth' });
        }, 300);
    }
}

function getFinalSummary() {
    console.log('ã€DEBUGã€‘getFinalSummary å‘¼ã³å‡ºã—');
    document.getElementById('finalSummaryButton').disabled = true;
    
    fetch('/final_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('ã€DEBUGã€‘/final_summary ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('ã€DEBUGã€‘æœ€çµ‚è¦ç´„ãƒ‡ãƒ¼ã‚¿:', data);
        if (data.error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + data.error);
        } else {
            console.log('ã€DEBUGã€‘æœ€çµ‚è¦ç´„ã‚’è¡¨ç¤ºã—ã¾ã™:', data.summary);
            document.getElementById('finalSummaryContent').textContent = data.summary;
            document.getElementById('finalSummarySection').style.display = 'block';
            document.getElementById('finalSummaryButton').style.display = 'none';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¦ç´„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚„ã™ã
            setTimeout(() => {
                document.getElementById('finalSummarySection').scrollIntoView({ behavior: 'smooth' });
            }, 500);
        }
        document.getElementById('finalSummaryButton').disabled = false;
    })
    .catch(error => {
        console.error('ã€DEBUGã€‘Error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        document.getElementById('finalSummaryButton').disabled = false;
    });
}

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Edgeã€Safariã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (recognition && recognition.isListening) {
        stopVoiceInput();
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    const statusDiv = document.getElementById('voiceInputStatus');
    const statusText = document.getElementById('voiceStatusText');
    const voiceBtn = document.getElementById('voiceInputBtn');
    
    recognition.onstart = function() {
        recognition.isListening = true;
        statusDiv.style.display = 'block';
        statusText.textContent = 'éŸ³å£°ã‚’èªè­˜ä¸­...';
        voiceBtn.classList.add('btn-danger');
        voiceBtn.classList.remove('btn-outline-primary');
        
        // éŸ³å£°å…¥åŠ›ä¸­ã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
        const placeholderText = document.getElementById('inputPlaceholderText');
        if (placeholderText) {
            placeholderText.style.display = 'none';
        }
    };
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        const input = document.getElementById('reflectionInput');
        const placeholderText = document.getElementById('inputPlaceholderText');
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…¥åŠ›æ¬„ã«åæ˜ ï¼ˆå³åº§ã«æ›´æ–°ï¼‰
        if (interimTranscript || finalTranscript) {
            // æœ€æ–°ã®éŸ³å£°å…¥åŠ›ã‚’è¿½åŠ 
            input.value += finalTranscript + interimTranscript;
            
            // å…¥åŠ›æ¬„ã‚’ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            input.focus();
            input.scrollTop = input.scrollHeight;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã«ã‚‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
            if (placeholderText) {
                placeholderText.textContent = input.value;
            }
            
            // é€”ä¸­çµæœã‹ç¢ºå®šçµæœã‹ã§è¡¨ç¤ºã‚’åˆ†ã‘ã‚‹
            if (interimTranscript) {
                statusText.textContent = 'ğŸ¤ èªè­˜ä¸­: ' + interimTranscript;
                console.log('é€”ä¸­çµæœ:', interimTranscript);
            }
            
            if (finalTranscript) {
                statusText.textContent = 'âœ… èªè­˜å®Œäº†: ' + finalTranscript;
                console.log('ç¢ºå®šçµæœ:', finalTranscript);
            }
        }
    };
    
    recognition.onerror = function(event) {
        console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
        statusDiv.style.display = 'none';
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-primary');
        recognition.isListening = false;
        
        if (event.error === 'no-speech') {
            alert('éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        } else if (event.error === 'not-allowed') {
            alert('ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    };
    
    recognition.onend = function() {
        setTimeout(() => {
            statusDiv.style.display = 'none';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-primary');
            recognition.isListening = false;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
            const placeholderText = document.getElementById('inputPlaceholderText');
            if (placeholderText) {
                placeholderText.style.display = 'block';
            }
        }, 1000);
    };
    
    recognition.start();
}

function stopVoiceInput() {
    if (recognition && recognition.isListening) {
        recognition.stop();
        recognition.isListening = false;
    }
}

// å¾©å¸°æ™‚ã«éå»ã®ä¼šè©±ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function restoreReflectionConversation(conversationHistory) {
    const messagesContainer = document.getElementById('reflectionMessages');
    if (!messagesContainer || !conversationHistory || conversationHistory.length === 0) return;
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ã‚’ä¿å­˜
    const messages = messagesContainer.querySelectorAll('.message');
    const initialAIMessage = messages[0]; // æœ€åˆã®AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const userInputArea = messagesContainer.querySelector('.user-input-area'); // å…¥åŠ›ã‚¨ãƒªã‚¢
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ä»¥å¤–ã‚’å‰Šé™¤
    for (let i = messages.length - 1; i > 0; i--) {
        messages[i].remove();
    }
    
    // éå»ã®ä¼šè©±ã‚’å¾©å…ƒï¼ˆåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ã®é–“ã«æŒ¿å…¥ï¼‰
    conversationHistory.forEach((msg, index) => {
        const isAI = msg.role === 'assistant';
        const messageDiv = document.createElement('div');
        messageDiv.className = isAI ? 'message ai-message' : 'message user-message';
        
        if (isAI) {
            messageDiv.innerHTML = `
                <div class="message-avatar"></div>
                <div class="message-content">${msg.content}</div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="user-message-bubble">${msg.content}</div>
            `;
        }
        
        // å…¥åŠ›ã‚¨ãƒªã‚¢ã®ç›´å‰ã«æŒ¿å…¥
        if (userInputArea) {
            userInputArea.parentNode.insertBefore(messageDiv, userInputArea);
        } else {
            messagesContainer.appendChild(messageDiv);
        }
    });
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿‘ãã«
    if (userInputArea) {
        userInputArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // ä¼šè©±å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    let userHistoryCount = 0;
    let aiHistoryCount = 0;
    conversationHistory.forEach(msg => {
        if (msg.role === 'assistant') {
            aiHistoryCount++;
        } else if (msg.role === 'user') {
            userHistoryCount++;
        }
    });
    const exchanges = Math.min(userHistoryCount, aiHistoryCount);
    reflectionExchangeCount = exchanges;
    
    // è¦ç´„ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¤å®š
    if (reflectionResumptionInfo && !reflectionResumptionInfo.reflection_summary_created && exchanges >= 2) {
        showFinalSummaryButton(`å±¥æ­´ã‹ã‚‰è¦å®šå›æ•°é”æˆï¼ˆ${exchanges}å›ï¼‰`);
    }
}

// å¾©å¸°æ™‚ã«è€ƒå¯Ÿã®ã¾ã¨ã‚ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function showReflectionSummary(summary) {
    const finalSummarySection = document.getElementById('finalSummarySection');
    const finalSummaryContent = document.getElementById('finalSummaryContent');
    
    if (finalSummarySection && finalSummaryContent) {
        finalSummaryContent.textContent = summary;
        finalSummarySection.style.display = 'block';
    }
}

// ã‚¨ãƒ©ãƒ¼å ±å‘Šé–¢æ•°
function reportError(errorMessage, errorType = 'client_error', additionalInfo = {}) {
    const stage = '{{ session.get("current_stage", "reflection") }}';
    const unit = '{{ session.get("unit", "") }}';
    
    console.error(`[ERROR REPORT] ${errorType}: ${errorMessage}`);
    
    fetch('/report_error', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            error_message: errorMessage,
            error_type: errorType,
            stage: stage,
            unit: unit,
            additional_info: additionalInfo
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('[ERROR REPORT] Success:', data);
    })
    .catch(error => {
        console.error('[ERROR REPORT] Failed:', error);
    });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
window.addEventListener('error', (event) => {
    const errorMessage = event.message || 'Unknown error';
    const errorSource = event.filename || 'unknown';
    const errorLine = event.lineno || 'unknown';
    
    reportError(`${errorMessage} (${errorSource}:${errorLine})`, 'javascript_error', {
        filename: errorSource,
        lineno: errorLine,
        colno: event.colno
    });
});

// Promise ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
window.addEventListener('unhandledrejection', (event) => {
    const errorMessage = event.reason ? String(event.reason) : 'Unknown promise rejection';
    reportError(errorMessage, 'promise_error', {
        reason: event.reason
    });
});
</script>
{% endblock %}

