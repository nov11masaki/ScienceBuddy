{% extends "base.html" %}

{% block title %}考察をまとめよう{% endblock %}

{% block content %}
<div class="reflection-page">
    <div class="container-fluid">
        <div class="reflection-header text-center mb-3">
            <h2 class="mb-2">
                <i class="fas fa-lightbulb text-primary"></i>
                考察をまとめよう
            </h2>
            <div class="unit-display">
                <span class="badge bg-primary fs-6">{{ unit }}</span>
            </div>
        </div>
        
        <div class="row g-3">
            <!-- 左側: 対話エリア -->
            <div class="col-lg-7 chat-column">
                <div class="prediction-review mb-3">
                    <div class="review-card">
                        <h5 class="review-title">
                            <i class="fas fa-brain"></i>
                            あなたの予想
                        </h5>
                        <p class="review-content">{{ prediction_summary or '予想が記録されていません。' }}</p>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="reflectionMessages">
                        <!-- 初期メッセージはJavaScriptで動的に追加 -->
                    </div>
                    
                    <div class="chat-input-section mt-3">
                        <div class="input-group">
                            <textarea class="form-control" id="reflectionInput" rows="3" 
                                    placeholder="実験結果を入力してください..."></textarea>
                            <button class="btn btn-primary" id="sendReflectionButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons text-center mt-3">
                    <button class="btn btn-success" id="finalSummaryButton" style="display: none;">
                        <i class="fas fa-file-alt me-2"></i>
                        考察をまとめる
                    </button>
                </div>
                
                <div class="final-summary-section" id="finalSummarySection" style="display: none;">
                    <div class="final-summary-card">
                        <h5 class="final-summary-title">
                            <i class="fas fa-graduation-cap"></i>
                            最終考察
                        </h5>
                        <div class="final-summary-content" id="finalSummaryContent"></div>
                        <div class="text-center mt-3">
                            <a href="/" class="btn btn-primary">
                                <i class="fas fa-home me-2"></i>
                                ホームに戻る
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右側: 入力補助エリア -->
            <div class="col-lg-5 input-column">
                <div class="input-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-keyboard"></i> 入力補助
                    </h5>
                    
                    <!-- 入力補助機能の切り替えスイッチ -->
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="inputAssistToggle">
                        <label class="form-check-label" for="inputAssistToggle">
                            入力補助を使う
                        </label>
                    </div>
                    
                    <!-- タッチキーボード -->
                    <div class="touch-keyboard" id="touchKeyboard" style="display: none;">
                        <div class="keyboard-section">
                            <small class="text-muted d-block mb-2">ひらがな</small>
                            <div class="keyboard-grid" id="hiraganaKeys">
                                <!-- JavaScriptで動的に生成 -->
                            </div>
                            <div class="keyboard-controls mt-2">
                                <button class="btn btn-warning btn-sm" id="backspaceBtn">
                                    <i class="fas fa-backspace"></i> 戻す
                                </button>
                                <button class="btn btn-danger btn-sm" id="clearBtn">
                                    <i class="fas fa-times"></i> 消去
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 音声入力 -->
                    <div class="voice-input-section mt-3" id="voiceInputSection" style="display: none;">
                        <button class="btn btn-outline-primary w-100" id="voiceInputBtn">
                            <i class="fas fa-microphone"></i> 音声で入力
                        </button>
                        <div class="voice-input-status mt-2" id="voiceInputStatus" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-microphone"></i>
                                <span id="voiceStatusText">音声を認識中...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conversationCount = 0;
let reflectionCount = 0;

// 入力補助用の設定
const inputAssistConfig = {
    hiragana: [
        // あ行
        ['あ', 'い', 'う', 'え', 'お'],
        // か行
        ['か', 'き', 'く', 'け', 'こ'],
        // さ行
        ['さ', 'し', 'す', 'せ', 'そ'],
        // た行
        ['た', 'ち', 'つ', 'て', 'と'],
        // な行
        ['な', 'に', 'ぬ', 'ね', 'の'],
        // は行
        ['は', 'ひ', 'ふ', 'へ', 'ほ'],
        // ま行
        ['ま', 'み', 'む', 'め', 'も'],
        // や行
        ['や', '', 'ゆ', '', 'よ'],
        // ら行
        ['ら', 'り', 'る', 'れ', 'ろ'],
        // わ行
        ['わ', '', '', '', 'ん'],
        // 濁音・半濁音
        ['が', 'ぎ', 'ぐ', 'げ', 'ご'],
        ['ざ', 'じ', 'ず', 'ぜ', 'ぞ'],
        ['だ', 'ぢ', 'づ', 'で', 'ど'],
        ['ば', 'び', 'ぶ', 'べ', 'ぼ'],
        ['ぱ', 'ぴ', 'ぷ', 'ぺ', 'ぽ'],
        // 小文字・記号
        ['っ', 'ゃ', 'ゅ', 'ょ', 'を'],
        ['。', '、', ' ', '', '']
    ]
};

const currentUnit = "{{ unit }}";
let recognition = null;

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 初期メッセージを表示（サーバーから渡されたメッセージを使用）
    const initialMessage = '{{ initial_ai_message }}';
    addReflectionMessage(initialMessage, 'ai');
    
    // 入力補助の初期化
    initializeInputAssist();
    
    // 入力補助トグル
    document.getElementById('inputAssistToggle').addEventListener('change', function(e) {
        toggleInputAssist(e.target.checked);
    });
    
    // バックスペースボタン
    document.getElementById('backspaceBtn').addEventListener('click', function() {
        const input = document.getElementById('reflectionInput');
        input.value = input.value.slice(0, -1);
        input.focus();
    });
    
    // 消去ボタン
    document.getElementById('clearBtn').addEventListener('click', function() {
        document.getElementById('reflectionInput').value = '';
        document.getElementById('reflectionInput').focus();
    });
    
    // 音声入力ボタン
    document.getElementById('voiceInputBtn').addEventListener('click', startVoiceInput);
});

document.getElementById('sendReflectionButton').addEventListener('click', sendReflection);
document.getElementById('reflectionInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendReflection();
    }
});

document.getElementById('finalSummaryButton').addEventListener('click', getFinalSummary);

function sendReflection() {
    const input = document.getElementById('reflectionInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ユーザーメッセージを表示
    addReflectionMessage(message, 'user');
    input.value = '';
    
    // 送信ボタンを無効化
    document.getElementById('sendReflectionButton').disabled = true;
    
    // APIリクエストデータ
    const requestData = { 
        message: message
    };
    
    // AIの応答を取得
    fetch('/reflect_chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTPエラー: ${response.status} ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            addReflectionMessage('エラーが発生しました: ' + data.error, 'ai');
        } else {
            addReflectionMessage(data.response, 'ai');
            reflectionCount++;
            
            // サーバーからの判定に基づいて、まとめボタンを表示
            // 最低2往復の対話が行われた場合のみ表示
            if (data.suggest_final_summary) {
                document.getElementById('finalSummaryButton').style.display = 'block';
            }
        }
        
        // 送信ボタンを有効化
        document.getElementById('sendReflectionButton').disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        addReflectionMessage('通信エラーが発生しました: ' + error.message, 'ai');
        document.getElementById('sendReflectionButton').disabled = false;
    });
}

function addReflectionMessage(content, type) {
    const messagesContainer = document.getElementById('reflectionMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    messageDiv.innerHTML = `
        <div class="message-avatar"></div>
        <div class="message-content">
            ${content}
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getFinalSummary() {
    document.getElementById('finalSummaryButton').disabled = true;
    
    fetch('/final_summary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('エラーが発生しました: ' + data.error);
        } else {
            document.getElementById('finalSummaryContent').textContent = data.summary;
            document.getElementById('finalSummarySection').style.display = 'block';
            document.getElementById('finalSummaryButton').style.display = 'none';
        }
        document.getElementById('finalSummaryButton').disabled = false;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('通信エラーが発生しました。');
        document.getElementById('finalSummaryButton').disabled = false;
    });
}

// 入力補助関数
function initializeInputAssist() {
    // ひらがなキーボードを設定（5列グリッドレイアウト）
    const hiraganaContainer = document.getElementById('hiraganaKeys');
    hiraganaContainer.innerHTML = '';
    
    inputAssistConfig.hiragana.forEach(row => {
        row.forEach(char => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-primary touch-key';
            if (char === '') {
                // 空白セル
                btn.style.visibility = 'hidden';
                btn.textContent = ' ';
            } else {
                btn.textContent = char;
                btn.onclick = () => insertText(char);
            }
            hiraganaContainer.appendChild(btn);
        });
    });
}

// 入力補助の表示切り替え
function toggleInputAssist(enabled) {
    const keyboardDiv = document.getElementById('touchKeyboard');
    const voiceDiv = document.getElementById('voiceInputSection');
    
    if (enabled) {
        keyboardDiv.style.display = 'block';
        voiceDiv.style.display = 'block';
    } else {
        keyboardDiv.style.display = 'none';
        voiceDiv.style.display = 'none';
        stopVoiceInput();
    }
}

function insertText(text) {
    const input = document.getElementById('reflectionInput');
    input.value += text;
    input.focus();
}

function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('お使いのブラウザは音声入力に対応していません。Chrome、Edge、Safariをお使いください。');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (recognition && recognition.isListening) {
        stopVoiceInput();
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.lang = 'ja-JP';
    recognition.continuous = false;
    recognition.interimResults = true;
    
    const statusDiv = document.getElementById('voiceInputStatus');
    const statusText = document.getElementById('voiceStatusText');
    const voiceBtn = document.getElementById('voiceInputBtn');
    
    recognition.onstart = function() {
        recognition.isListening = true;
        statusDiv.style.display = 'block';
        statusText.textContent = '音声を認識中...';
        voiceBtn.classList.add('btn-danger');
        voiceBtn.classList.remove('btn-outline-primary');
    };
    
    recognition.onresult = function(event) {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }
        
        if (interimTranscript) {
            statusText.textContent = '認識中: ' + interimTranscript;
        }
        
        if (finalTranscript) {
            const input = document.getElementById('reflectionInput');
            input.value += finalTranscript;
            statusText.textContent = '認識完了: ' + finalTranscript;
        }
    };
    
    recognition.onerror = function(event) {
        console.error('音声認識エラー:', event.error);
        statusDiv.style.display = 'none';
        voiceBtn.classList.remove('btn-danger');
        voiceBtn.classList.add('btn-outline-primary');
        recognition.isListening = false;
        
        if (event.error === 'no-speech') {
            alert('音声が検出されませんでした。もう一度お試しください。');
        } else if (event.error === 'not-allowed') {
            alert('マイクの使用が許可されていません。ブラウザの設定を確認してください。');
        }
    };
    
    recognition.onend = function() {
        setTimeout(() => {
            statusDiv.style.display = 'none';
            voiceBtn.classList.remove('btn-danger');
            voiceBtn.classList.add('btn-outline-primary');
            recognition.isListening = false;
        }, 1000);
    };
    
    recognition.start();
}

function stopVoiceInput() {
    if (recognition && recognition.isListening) {
        recognition.stop();
        recognition.isListening = false;
    }
}
</script>
{% endblock %}
