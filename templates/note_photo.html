{% extends "base.html" %}

{% block title %}ãƒãƒ¼ãƒˆå†™çœŸæ’®å½±{% endblock %}

{% block content %}
<div class="note-photo-page">
    <div class="container-fluid">
        <div class="text-center mb-4">
            <div class="class-info-banner mb-3">
                <span class="class-badge">ï¼”å¹´<span id="selectedClass"></span>çµ„ <span id="selectedNumber"></span>ç•ª</span>
            </div>
            <h2 class="mb-3">
                <i class="fas fa-camera text-primary"></i>
                ãƒãƒ¼ãƒˆå†™çœŸã‚’æ’®å½±ã—ã¦ãã ã•ã„
            </h2>
            <p class="text-muted">ã‚«ãƒ¡ãƒ©ã§ãƒãƒ¼ãƒˆã®å†™çœŸã‚’æ’®ã‚Šã¾ã™ã€‚è¤‡æ•°æšæ’®å½±ã§ãã¾ã™</p>
        </div>

        <div class="row">
            <!-- ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="col-lg-8">
                <div class="camera-section">
                    <video id="cameraPreview" autoplay playsinline></video>
                    <div class="camera-controls mb-3">
                        <button class="btn btn-primary btn-lg w-100" id="captureBtn">
                            <i class="fas fa-camera"></i> æ’®å½±ã™ã‚‹
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ’®å½±æ¸ˆã¿å†™çœŸä¸€è¦§ -->
            <div class="col-lg-4">
                <div class="photos-section">
                    <h5 class="mb-3">
                        <i class="fas fa-images"></i> æ’®å½±æ¸ˆã¿å†™çœŸ
                        <span class="badge bg-primary" id="photoCount">0</span>
                    </h5>
                    <div id="photoGallery" class="photo-gallery mb-3">
                        <!-- æ’®å½±æ¸ˆã¿å†™çœŸãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>

                    <div id="emptyState" class="text-center text-muted py-5">
                        <p>ğŸ“¸ å†™çœŸãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="submitBtn" disabled>
                            <i class="fas fa-check"></i> é€ä¿¡ã™ã‚‹
                        </button>
                        <button class="btn btn-warning btn-lg" id="retakeBtn" disabled>
                            <i class="fas fa-redo"></i> æœ€æ–°ã®å†™çœŸã‚’å‰Šé™¤
                        </button>
                        <a href="#" onclick="goBack()" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Canvas for image captureï¼ˆéè¡¨ç¤ºï¼‰ -->
<canvas id="captureCanvas" style="display: none;"></canvas>

{% endblock %}

{% block scripts %}
<script>
// URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
const urlParams = new URLSearchParams(window.location.search);
const classNumber = urlParams.get('class') || '1';
const studentNumber = urlParams.get('number') || '1';
const unit = urlParams.get('unit') || '';

// UIè¡¨ç¤º
document.getElementById('selectedClass').textContent = classNumber;
document.getElementById('selectedNumber').textContent = studentNumber;

// æ’®å½±æ¸ˆã¿å†™çœŸã®ãƒ‡ãƒ¼ã‚¿URLé…åˆ—
let capturedPhotos = [];
let videoStream = null;

// ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
async function initCamera() {
    try {
        const video = document.getElementById('cameraPreview');
        videoStream = await navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: { ideal: 'environment' },  // å¤–ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            audio: false
        });
        video.srcObject = videoStream;
        video.play();
    } catch (error) {
        console.error('ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }
}

// å†™çœŸæ’®å½±
document.getElementById('captureBtn').addEventListener('click', function() {
    const video = document.getElementById('cameraPreview');
    const canvas = document.getElementById('captureCanvas');
    const ctx = canvas.getContext('2d');

    // ãƒ“ãƒ‡ã‚ªã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è¨­å®š
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // ãƒ“ãƒ‡ã‚ªã®ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
    ctx.drawImage(video, 0, 0);

    // ãƒ‡ãƒ¼ã‚¿URLã‚’å–å¾—ã—ã¦é…åˆ—ã«è¿½åŠ 
    const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
    capturedPhotos.push(photoDataUrl);

    // ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«è¡¨ç¤º
    displayPhotos();

    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    updateButtonStates();

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    showToast(`ğŸ“¸ ${capturedPhotos.length}æšç›®ã‚’æ’®å½±ã—ã¾ã—ãŸ`, 'success');
});

// ã‚®ãƒ£ãƒ©ãƒªãƒ¼è¡¨ç¤º
function displayPhotos() {
    const gallery = document.getElementById('photoGallery');
    const emptyState = document.getElementById('emptyState');
    const photoCount = document.getElementById('photoCount');

    gallery.innerHTML = '';
    photoCount.textContent = capturedPhotos.length;

    if (capturedPhotos.length === 0) {
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';

    capturedPhotos.forEach((photo, index) => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item mb-2';
        photoItem.innerHTML = `
            <div class="position-relative">
                <img src="${photo}" alt="å†™çœŸ ${index + 1}" class="img-fluid rounded">
                <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" 
                        onclick="removePhoto(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <small class="text-muted d-block mt-1">å†™çœŸ ${index + 1}</small>
        `;
        gallery.appendChild(photoItem);
    });
}

// å†™çœŸå‰Šé™¤
function removePhoto(index) {
    capturedPhotos.splice(index, 1);
    displayPhotos();
    updateButtonStates();
    showToast('å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
}

// ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
function updateButtonStates() {
    const submitBtn = document.getElementById('submitBtn');
    const retakeBtn = document.getElementById('retakeBtn');

    submitBtn.disabled = capturedPhotos.length === 0;
    retakeBtn.disabled = capturedPhotos.length === 0;
}

// é€ä¿¡
document.getElementById('submitBtn').addEventListener('click', async function() {
    this.disabled = true;
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';

    try {
        // å†™çœŸã‚’Blobé…åˆ—ã«å¤‰æ›
        const formData = new FormData();
        formData.append('class', classNumber);
        formData.append('number', studentNumber);
        formData.append('unit', unit);

        // å„å†™çœŸã‚’Blobå½¢å¼ã§è¿½åŠ 
        for (let i = 0; i < capturedPhotos.length; i++) {
            const blob = await fetch(capturedPhotos[i]).then(r => r.blob());
            formData.append('photos', blob, `note_${i + 1}.jpg`);
        }

        const response = await fetch('/upload_note_photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            showToast('ğŸ“¸ å†™çœŸã‚’é€ä¿¡ã—ã¾ã—ãŸï¼', 'success');
            setTimeout(() => {
                goBack();
            }, 1500);
        } else {
            alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message);
            this.disabled = false;
            this.innerHTML = originalText;
        }
    } catch (error) {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        this.disabled = false;
        this.innerHTML = originalText;
    }
});

// æ’®ã‚Šç›´ã—ï¼ˆæœ€æ–°ã®å†™çœŸã‚’1æšå‰Šé™¤ï¼‰
document.getElementById('retakeBtn').addEventListener('click', function() {
    if (capturedPhotos.length > 0) {
        capturedPhotos.pop();  // æœ€æ–°ã®å†™çœŸã‚’1æšå‰Šé™¤
        displayPhotos();
        updateButtonStates();
        showToast('æœ€æ–°ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
    }
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function goBack() {
    // ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
    history.back();
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–
window.addEventListener('load', initCamera);

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
window.addEventListener('beforeunload', () => {
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
    }
});
</script>

<style>
.note-photo-page {
    min-height: 100vh;
    background: #f5f5f5;
    padding: 30px 20px;
}

.camera-section {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

#cameraPreview {
    width: 100%;
    height: auto;
    background: #000;
    border-radius: 12px;
    object-fit: cover;
}

.camera-controls {
    padding: 15px;
    background: white;
}

.photos-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    height: fit-content;
    position: sticky;
    top: 20px;
}

.photo-gallery {
    max-height: 600px;
    overflow-y: auto;
}

.photo-item {
    position: relative;
}

.photo-item img {
    max-width: 100%;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    transition: transform 0.2s;
}

.photo-item img:hover {
    transform: scale(1.02);
}

.toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.toast-notification.show {
    opacity: 1;
}

.toast-success {
    background: #28a745;
}

.toast-info {
    background: #17a2b8;
}

.toast-error {
    background: #dc3545;
}

@media (max-width: 768px) {
    .photos-section {
        margin-top: 20px;
        position: static;
    }
}
</style>
{% endblock %}
